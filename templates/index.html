<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="static/icon-black.png">
    <meta charset="UTF-8">
    <title>Anolog</title>
    <style>
        :root {
            --primary-color: {{primary_color}};
        }
        .logo {
            position: relative;
            top: 2px;
            width: 24px;
            height: 24px;
            background: conic-gradient(transparent 0% 25%, #161616 25% 100%);
            border-radius: 50%;
            margin-right: 8px;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, sans-serif;
            width: 75vw;
            height: 90vh;
            margin: 50px;
            margin-left: auto;
            margin-right: auto;
            background-color:var(--primary-color);
            transition: 0.2s ease;
        }
        h1 {
            margin: 0;
            display: flex;
            width: 200px;
            align-items: center;
        }
        header {
            margin-bottom: 25px;
            color: var(--primary-color);
            text-align: left;
            align-items: center;
            display: flex;
        }
        #tool-div {
            position: relative;
            display: flex;
            width: 100%;
            margin-left: 25px;
            justify-content: right;
        }
        .header-icon {
            vertical-align: middle;
            width: 30px;
            height: 30px;
            margin-right: 10px;
            padding-bottom: 5px;
        }
        .signin-input {
            font: inherit;
            width: 125px;
            border: none;
            background: none;
            border-bottom: 1px solid #161616;
            outline: none;
            color: #161616;
            opacity: 0.5;
            transition: 0.2s ease;
        }
        .signin-input:hover {
            opacity: 1;
        }
        /* Webkit browsers like Chrome, Safari */
        ::-webkit-scrollbar {
            cursor: pointer;
            width: 10px;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background:  var(--primary-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background:  var(--primary-color);
        }
        .fa-solid, .fas {
            font-size: 16px;
            font-weight: 900;
        }
        .fa-regular, .far {
            font-size: 14pt;
            font-weight: 400;
        }
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #161616 var(--primary-color);
        }
        .content-div{
            margin-top: 25px;
            display: flex;
        }
        .list-container {
            flex-shrink: 0;
            overflow:hidden;
            box-sizing: border-box;
            background-color: #161616;
            border-radius: 10px;
            margin-bottom: 0px;
            margin-right: 25px;
            height: 40px;
            width: 40px;
            transition: 0.2s ease;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }
        .list-container:focus-within {
            overflow:visible; 
            color: #161616;           
            width: 270px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }
        .list-collapsed #project-list-ul, .list-collapsed #task-list-ul {
            transition: 0.2s ease;
            opacity: 0;
        }
        .list-collapsed:hover #project-list-ul, .list-collapsed:hover #task-list-ul, .list-container:focus-within #project-list-ul, .list-container:focus-within #task-list-ul {
            transition: 0.2s ease;
            opacity: 1;
        }
        .list-collapsed { 
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            border: 0;
            padding: 0;
            color: transparent;   
            overflow: hidden;     
            height: 40px !important;
            width: 40px !important;
        }
        #project-list-container {
            width: 90%;
        }
        #task-list-container {
            width: 90%;
        }

        .list-div {
            display: block;
            margin-top: 20px;
            margin-left: 30px;
            width: 240px;
            height: auto;
        }
        .divider {
            margin-top: 10px;
            margin-bottom: 25px;
            border-radius: 5px;
            border-top: 3px solid var(--primary-color);
            height: 1px;
            width: 100%;
        }
        .log-divider {
            margin-top: 15px;
            margin-bottom: 15px;
            border-top: 1px solid  var(--primary-color);
            height: 1px;
            width: 100%;
        }
        #menu-button {
            color:var(--primary-color);
            cursor: pointer;
            transition: 0.2s ease;
        }
        .toggle {
            border-radius: 10px 10px 0px 0px;
            background-color: #161616;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
            margin-bottom: 20px;
            height: 40px;
            transition: 0.2s ease;
            cursor: pointer;
        }
        .toggle:hover #menu-button {
            opacity: 0.5;
            justify-content: left;
        }
        a {
            color: rgb(0, 0, 0);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-bottom 0.2s ease;
        }
        a:hover {
            border-bottom: 1px solid #161616;
        }
        .task-or-project {
            font-size: 12pt;
            display: inline;  
            cursor: pointer;
            color: var(--primary-color);
            border-bottom: 1px solid transparent;
            transition: 0.1s ease;
        }
        .task-or-project:hover {
            border-bottom: 1px solid var(--primary-color);
        }
        h2 {
            font-size:12pt;
            color: var(--primary-color);
            margin-top: 5px;
            margin-bottom: 0px;
        }
        #project-list-ul {
            margin-top: 5px;
            margin-bottom: 20px;
            width: 90%;
            height: auto;
            max-height: 140px;
            overflow-y: scroll;
            font-size: large;
            margin-left: 0;
            padding-left: 20px;
            color: var(--primary-color);
        }
        #task-list-ul {
            margin-top: 5px;
            margin-bottom: 10px;
            width: 90%;
            height: auto;
            max-height: 250px;
            overflow-y: scroll;
            margin-left: 0;
            padding-left: 20px;
            list-style-type:circle;
            color: var(--primary-color);
        }
        #new-project-li, #new-task-li {
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }
        li {
            margin-bottom: 5px;
        }
        .task-or-project-li {
            margin-right: 20px;
        }
        #new-project-input, #new-task-input, .rename-input{
            font: inherit;
            width: 125px;
            border: none;
            background: none;
            border-bottom: 1px solid var(--primary-color);
            outline: none;
            color: var(--primary-color);
        }
        #new-project-li:hover,
        #new-project-li:focus-within,
        #new-task-li:hover,
        #new-task-li:focus-within {
            opacity: 1;
        }
        #log-div {
            display: grid;
            width: 100%;
            height: 100%;
            margin-bottom: 25px;
            transition: 0.2s ease;
        }
        .log-space {
            padding: 30px;
            margin-top: 25px;
            background-color: #161616;
            border:  #161616 solid 2px;
            border-radius: 10px;
            min-height: 600px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            transition: opacity 0.5s ease;
        }
        #project-name {
            font-size: 16pt;
            margin-bottom: 5px;
            margin-top: 0px;
        }
        #project-space {
            display: flex;
            padding: 30px;
            overflow-y: scroll;
            background-color: #161616;
            border:  #161616 solid 2px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }
        #project-content {
            width: 38%;
            margin-right: 2%;
            color:   var(--primary-color);
        }
        #time-content {
            width: 60%;
        }
        #time-content-from-to-date {
            color: var(--primary-color);
            opacity: 0.5;
        }
        #log-content{
            visibility: hidden;
            min-height: 95%;
            color:  var(--primary-color);
        }
        #log-input {
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12pt;
            margin-top: 25px;
            margin-bottom: 0px;
            color: var(--primary-color);
            width: -webkit-fill-available;
            height: 75px;
            background: none;
            border: 2px solid var(--primary-color);
            outline: none;
            border-radius: 6px;
            opacity: 1;
            transition: opacity 0.2s ease;
            padding: 10px;
        }
        #log-input::placeholder {
            color: var(--primary-color);
            opacity: 1;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, sans-serif;
            font-size: 12pt;
        }
        #log-input:focus,
        #log-input:hover {
            opacity: 1;
        }
        .button-common {
            cursor: pointer;
            display: grid;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            width: 25px;
            height: 25px;
            margin: auto;
            padding: 0px;
            margin-right: 3px;
            margin-left: 0px;
            background: none;
            color:  var(--primary-color);
            border: none;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .button-common:hover {
            opacity: 0.5;
        }
        .button-rotated {
            transform: rotate(0deg);
        }
        .button-spinning {
            transform: rotate(360deg);
        }
        #clock-div {
            margin-top: 20px;
            display: flex;
        }

        #task-name {
            margin: 0;
            margin-right: 10px;
            margin-top: auto;
            margin-bottom: auto;
            transition: opacity 0.2s ease;
        }
        #task-checkbox {
            margin-left: 0;
            margin-right: auto;
            margin-top: 6px;
            margin-bottom: auto;
        }
        #task-name:hover{
            opacity: 0.5;
        }
        #clock {
            cursor: pointer;
            margin-left: 6px;
            margin-top: auto;
            margin-bottom: auto;
        }
        #log-items-container {
            padding-right: 10px;
            padding-left: 10px;
            height: auto;
            opacity: 1;
            overflow-y: scroll;
        }
        #pinned-logs-container {
            margin-top: 20px;
            opacity: 1;
            box-shadow: 0 16px 13px -6px rgba(0, 0, 0, 0.5)
        }
        ::-webkit-scrollbar {
            cursor: pointer;
            width: 5px;
        }
        ::-webkit-scrollbar-thumb {
            cursor: pointer;
            background: var(--primary-color) ; 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color); 
        }
        .log-item {
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
            transition: opacity 0.2s ease;
            font-size: 12pt;
            margin-bottom: 5px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
        }
        .log-created-at {
            opacity: 0.5;
        }
        #task-checkbox {
            display: none;
        }
        #task-checkbox + label {
            font-size: 14pt;
            display: flex;
            margin-right: auto;
            position: relative;
            padding-left: 35px;
            cursor: pointer;
            font-weight: bold;
        }
        #toggle-icon {
            font-size: 16pt;
        }
        #task-checkbox + label:before {
            margin-left: 4px;
            margin-right: auto;
            margin-top: auto;
            margin-bottom: auto;
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-45%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-color);
            background-color: transparent;
            border-radius: 3px;
        }
        #task-checkbox:checked + label:before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        #task-checkbox + label:after {
            content: "";
            position: absolute;
            top: 4px;
            left: 5px;
            width: 4px;
            height: 8px;
            border: solid #161616;
            border-width: 0 4px 4px 0;
            transform: rotate(45deg) scale(0);
        }
        .strikethrough {
            text-decoration: line-through;
        }
        .custom-hover-menu {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: small;
            position: absolute;
            color: #161616;
            width: 65px;
            height: 25px;
            list-style-type: none;
            border-radius: 5px;
            padding: 0;
            margin: 0;
            margin-left: 8px;
            z-index: 10;
            transition: opacity 0.2s ease;
            background-color: var(--primary-color);
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);

        }
        .custom-hover-menu li {
            margin-top: 3px;
            padding: 4px;
            cursor: pointer;
            transition: 0.2s ease;
        }
        .custom-hover-menu li:hover {
            opacity: 0.5;
        }
        .fade-out {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        #export-div, #logout-div {
            display:inline;
            width: 350px;
            margin-left: 50px;
        }
        .export-button {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            background-color: #161616;
            height: 40px;
            width: 40px;
            margin-bottom: 0px;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.2s ease;
            cursor: pointer;
        }
        .export-button:hover{
            opacity:0.5;
        }
        .export-option {
            background-color: #DDDDDD;
            height: 40px;
            width: 80px;
            margin-bottom: 0px;
            outline: none;
            border: none;
            color:#161616;
            transition: 0.2s ease-in-out;
            cursor: pointer;
        }
        .export-option:hover {
            background-color: #161616;
            color: var(--primary-color);
        }
        .logout-button {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            background-color: #161616;
            height: 40px;
            width: 40px;
            margin-left: 5px;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.2s ease;
            cursor: pointer;
        }
        .logout-button:hover{
            opacity:0.5;
        }

        .color-button {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            background-color: #161616;
            height: 40px;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 5px;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.2s ease;
            cursor: pointer;
        }
        .color-button:hover{
            opacity:0.5;
        }

        .darkmode-button {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            background-color: #161616;
            height: 40px;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.2s ease;
            cursor: pointer;
        }

        .darkmode-button:hover{
            opacity:0.5;
        }

        #side-div {
            width: 350px;
            margin-left: 50px;
            display: none;
        }
        #pin {
            margin-right:5px;
        }
        #user-id-container{
            visibility: hidden;
        }
        .dropdown-menu {
            height: 0px;
            width: 40px;
            display: grid;
            overflow: hidden;
            position: absolute;
            top: 100%;
            right: 45px; 
            z-index: 1; 
            transition: 0.2s ease;
        }
        #export-button:hover + .dropdown-menu,
        .dropdown-menu:hover {
            height: 160px;
            width: 80px;
            transition: 0.2s ease;
        }
        #export-button:hover  {
            width: 80px;
        }
        #time-csv {
            border-radius:  0 0 10px 10px;
        }
        #picker-label {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            margin: auto;
            height: 40px;
            cursor: pointer;
        }
        .confetti {
            position: fixed;
            width: 5px;
            height: 10px;
            background-color: var(--primary-color);
            opacity: 0.7;
            animation: confetti-animation 1s ease-out;
            animation-duration: var(--speed, 0.2s);

            --initial-x: 0px;
            --initial-y: 0px;
            --rotation: 0deg;
        }

        .toggle-completed {
            margin-left: 2px;
            width: 15px;
            color: #161616;
            font-size: 10pt;
            cursor: pointer;
            transition: 0.2s ease;
            opacity: 0.2;  
            width: 16px;
            overflow: hidden;
            color: var(--primary-color);
        }
        .list-container:hover .toggle-completed {
            opacity: 0.5; 
        }
        .toggle-completed:hover {
            opacity: 1 !important; 
        }
        .add-button {
            color: var(--primary-color);
            font-size: 12pt;
            cursor: pointer;
            transition: 0.2s ease;
            opacity: 0.2; 
            width: 16px;
            overflow: hidden;
        }
        .list-container:hover .add-button {
            opacity: 0.5; 
        }
        .add-button:hover {
            opacity: 1 !important; 
        }

        #add-a-time-block {
            color: var(--primary-color);
            font-size: 12pt;
            cursor: pointer;
            transition: 0.2s ease;
            opacity: 0.2; 
            overflow: hidden;
            width: 16px;
        }
        #add-a-time-block:hover {
            opacity: 1 !important; 
        }
        #project-space:hover #add-a-time-block {
            opacity: 0.5; 
        }

        #time-div {
            width: 100%;
            padding-top: 3px;
            padding-bottom: 3px;
            align-items: center;
            display: flex;
            height: 48px;
            background: #161616;
            transition: 0.2s ease;
        }
        .time-block {
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: clip;
            max-width: 100%;
            display: flex;
            color: #161616;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            margin-right: 2px;
            background-color:none;
            opacity: 1;
            height: 100%;
            transition: 0.2s ease;
            background-color: var(--primary-color);
        }
        .time-block:hover {
            opacity: 0.7 !important;
        }
        #time-description-container {
            padding-right: 2px;
            height: 0px;
            overflow: hidden;
            transition: 0.2s ease;
        }
        #time-description {
            padding-left: 25px;
            padding-right: 25px;
            padding-bottom: 20px;
            color: #161616;
            overflow: hidden;
            height: auto;
            background-color: var(--primary-color);
            border-radius: 0px 0px 7px 7px;
        }
        input[type="datetime-local"] {
            cursor: pointer;
            margin-bottom: 5px;
            font-family: Arial, Helvetica, sans-serif;
            appearance: none;
            -webkit-appearance: none;
            border: none;
            border-bottom: #161616 1px solid;
            padding: 5px;
            font-size: 14px;
            color: #161616;
            background-color: var(--primary-color);
            box-sizing: border-box;
            transition: 0.2s ease;
            outline: none;
            accent-color: var(--primary-color);
        }
        #time-description-hours {
            margin: 0;
        }

        #commit-time-block-button {
            cursor: pointer;
            color: #161616;
            display: none;
            margin-left: 10px;
            opacity: 1;
            transition: 0.2s ease;
        }
        #commit-time-block-button:hover {
            opacity: 0.6;
        }

        #x-axis-container {
            position: relative;
            width: 100%;
            height: 20px;
        }
        .x-axis {
            width: 100%;
            border: none;
            border-top: 2px solid var(--primary-color);
            position: absolute;
            bottom: 0;
            opacity: 0.5;
        }
        .marker {
            color: var(--primary-color);
            position: absolute;
            bottom: -20px; 
            opacity: 0.5;
        }

        #delete-time-block-button {
            cursor: pointer;
            margin-left: 5px;
            font-size: 10pt;
            transition: 0.2s;
        }
        #delete-time-block-button:hover {
            opacity: 0.6;
        }

        .log-options-div {
            width: 0px;
            transition: 0.2s ease;
            display: flex;
        }

        .log-option-button {
            color: var(--primary-color);
            opacity: 0.6;
            transition: 0.2s ease;
            width: auto;
            margin-right: 2px;
        }

        .log-option-button.dark {
            color: #161616 !important;
        }
        
        .log-item:hover .log-option-button {
            width: 20px !important; 
            overflow: visible;
        }

        .log-item:hover .log-option-button.pin {
            width: 16px !important;
        }

        .log-option-button.pin.pinned {
            width: 16px !important;
            opacity: 1;
        }

        .log-item:hover .log-options-div {
            width: 40px;
        }

        .log-option-button:hover {
            opacity: 1;
        }

        .log-edit-area {
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12pt;
            margin-top: 10px;
            margin-bottom: 0px;
            color: var(--primary-color);
            width: -webkit-fill-available;
            height: auto;
            background: none;
            border: 2px dashed var(--primary-color);
            outline: none;
            border-radius: 6px;
            opacity: 1;
            transition: opacity 0.2s ease;
            padding: 10px;
        }
        .log-edit-area.dark {
            color: #161616;
            border: 2px dashed #161616;
        }

        @keyframes fadeIn {
            0%, 100% {
                opacity: 1;
            }
            33% {
                opacity: 0.7;
            }
        }
        .fade-in-animation {
            animation: fadeIn 1s ease infinite;
        }
      
        @keyframes confetti-animation {
            0% {
                transform: translate(var(--initial-x), var(--initial-y)) rotate(var(--rotation));
                opacity: 1;
            }
            100% {
                transform: translate(calc(var(--initial-x) * 5), calc(var(--initial-y) * 4)) rotate(var(--rotation));
                opacity: 0;
            }
        }

        /* Mobile */
        @media only screen and (orientation: portrait) {
            body {
                width: 85vw;
            }
            #project-space {
                display: block;
            }
            #project-content {
                width: auto;
                margin-bottom: 15px;
            }
            #time-content {
                width: auto;
            }
            .content-div {
                display: block;
            }
            .list-div {
                width: 90%;
                display: flex;
            }
            #project-list-container {
                width: 50%;
                margin-right: 20px;
            }
            #task-list-container {
                width: 50%;
                margin-right: 20px;
            }
            .list-collapsed {
                width: 100% !important;
                margin-bottom: 25px;
            }
            .list-container {
                width: 100% !important;
                margin-bottom: 25px;
            }
            .list-collapsed:hover {
                overflow: hidden;
                height: 40px;
                width: 40px;
            }   
            #log-div {
                display: contents;
            }
        }
    </style>
</head>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<body>

    <header>
        <h1 class="header"><div class="logo"></div> Anolog</h1>
        <div id="tool-div">
            <div class="darkmode-button"><i id="darkmode-icon" class="fa-regular fa-moon"></i></div>
            <input type="color" title="Recolor" id="color-picker" value={{primary_color}} style="height:40px; width:0px; opacity: 0;">
            <div class="color-button"><label for="color-picker" id="picker-label"><i class="fa-solid fa-palette"></i></label></div>

            <button title="Export" class="export-button" id="export-button"><i class="fa-solid fa-file-arrow-down"></i></button>
            <div class="dropdown-menu" id="dropdown-menu">
                <button class="export-option" id="project-csv">Projects</button>
                <button class="export-option" id="task-csv">Tasks</button>
                <button class="export-option" id="log-csv">Logs</button>
                <button class="export-option" id="time-csv">Time</button>
            </div>

            <button title="Logout" class="logout-button" id="logout-button"><i class="fa-solid fa-right-from-bracket"></i></button>

        </div>
    </header>
    
    <div class="content-div">
        <div id='list-container' class="list-container">
            <div class="toggle">
                <i id="menu-button" class="fa-solid fa-square-minus"></i>
            </div>
            <div class="list-div">
                <div id="project-list-container">
                    <h2 class="header">Projects 
                        <i id="toggle-completed-projects" title="Show Completed Projects" class="toggle-completed fa-solid fa-eye-slash"></i>
                        <i id="add-a-project" title="Add a Project" class="add-button fa-solid fa-plus"></i>
                    </h2>
                    <ul id="project-list-ul">
                    </ul>
                </div>

                <div id="task-list-container">
                    <h2 class="header">Tasks 
                        <i id="toggle-completed-tasks" title="Show Completed Tasks" class="toggle-completed fa-solid fa-eye-slash"></i>
                        <i id="add-a-task" title="Add a Task" class="add-button fa-solid fa-plus"></i></h2>
                    <ul id="task-list-ul">
                    </ul>
                </div>

            </div>
        </div>

        <div id="log-div">

            <div id="project-space">
                <div id="project-content">
                    <h3 id="project-name"></h3>
                    <p id="hours-logged" style="margin:0; font-size:12pt;"></p>
                </div>
                <div id="time-content">
                    <div style="display: flex; width: 100%; align-items: center;">
                        <div id="time-div">
                        </div>
                        <i id="add-a-time-block" title="Add a Time Block" class="add-button fa-solid fa-plus" style="color: var(--primary-color);"></i>
                    </div>
    
                    <div id="time-description-container">
                        <div id="time-description">
                            <h4 style="margin-bottom: 5px; margin-top: 18px;">
                                <span id="duration"></span>
                                hours on 
                                <span id="time-description-task-name"></span>
                                <i id="delete-time-block-button" title="Delete Time Block" class="fa-solid fa-trash"></i>
                            </h4>
                            <input class='datetime-input' type="datetime-local" id="start-time-input"> to <input class='datetime-input' type="datetime-local" id="end-time-input"><i id="commit-time-block-button" title="Commit Changes" class="fa-solid fa-check"></i>
                        </div>
                    </div>
                </div>

        </div>
            <div class="log-space">
                <div id="log-content">
                    <div id="time">
                        <input type="checkbox" id="task-checkbox">
                        <label for="task-checkbox" id="task-name"></label>
                        
                        <h4 id="task-name"></h4>

                        <div id="clock-div">                        
                            <button id="toggle-button" class="button-common">
                            <i id="toggle-icon" class="fa-solid fa-hourglass-end"></i>
                          </button>
                          <p id="clock">00.00.00</p>
                        </div>

                    </div>
                    <textarea id="log-input" type="text" placeholder="Add a log entry"></textarea>
                    <div id="pinned-logs-container">
                        <!--Pinned logs go here -->
                    </div>
                    <div id="log-items-container">
                        <!-- Log items go here -->
                    </div>
                </div>
            </div>
        </div>
        <div id="side-div">
            <div id="logout-div">
                <h2>Account</h2>
                <button class="logout-button" id="logout-button"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            <div id="export-div">
                <h2>Export</h2>
                <button class="export-button" id="project-csv">Projects</button>
                <button class="export-button" id="task-csv">Tasks</button>
                <button class="export-button" id="log-csv">Logs</button>
                <button class="export-button" id="time-csv">Time</button>
            </div>
        </div>
    </div>

<script>
    // Set global variables
    var globalUserId = {{user_id}};
    var globalProjectId;
    var globalTaskId;
    var globalLogId;
    var globalSeconds;
    var darkmode = {{ darkmode|lower }};

    let intervalId = null;
    let firstLoad = true;
    let showCompletedTasks = false;
    let showCompletedProjects = false;

    // Clear local storage on first load
    window.onload = function() {
        localStorage.clear();
    };

    // GET from /projects endpoint and populate list
    function populateProjects() {
        const ulElement = document.getElementById('project-list-ul');
        const newProjectLi = document.getElementById('new-project-li');
        const projectNameLabel = document.getElementById('project-name');
        
        function displayProjectData(data) {
            ulElement.innerHTML = "";
            let first = true;
            data.forEach((project, index) => {
                if (project.is_visible !== false){
                    if (first===true && globalProjectId===undefined){
                        globalProjectId = project.id;
                        populateTasks(globalProjectId);
                        getTime(globalProjectId);
                        first = false;
                    }
                    const newListItem = document.createElement('li');
                    newListItem.classList.add('task-or-project-li');
                    const newLink = document.createElement('p');
                    newLink.className = 'task-or-project';

                    newLink.textContent = project.name;
                    newLink.setAttribute('data-projectId', project.id);
                    newListItem.appendChild(newLink);
                    newLink.style.opacity = '0.5';

                    if (project.id === globalProjectId){
                        newLink.style.opacity = '1';
                        newLink.style.fontWeight = 'bold';
                        projectNameLabel.textContent = project.name;
                        projectNameLabel.style.opacity = "1";
                    }
                    
                    if (project.is_completed) {
                        newLink.style.textDecoration = 'line-through';
                        newListItem.setAttribute('data-completed', true);
                        newListItem.style.height = '0px';
                        newListItem.style.overflow = 'hidden';
                        newListItem.style.margin = 'auto';
                    }
                    else {
                        newListItem.setAttribute('data-completed', false);
                    }

                    // Add click event listener to this list item
                    addProjectClickListener(newLink, project.id, project.name);
                    
                    // Add hover listener
                    addHoverListener(newLink, 'project', data.id);
                    
                    ulElement.appendChild(newListItem);
                }
            });
        }

        let cachedProjects = localStorage.getItem(`projects_cache_${globalUserId}`);
        if (cachedProjects) {
            displayProjectData(JSON.parse(cachedProjects));
            console.log('projects read from client-side cache')
        }
        else {
            fetch(`/projects`)
            .then(response => response.json())
            .then(data => {
                displayProjectData(data);
                localStorage.setItem(`projects_cache_${globalUserId}`, JSON.stringify(data));
            });
        }
    }

    // GET from /tasks endpoint and populate list
    function populateTasks(projectId) {

        function displayTaskData(data) {
            const taskUlElement = document.getElementById('task-list-ul');
            taskUlElement.innerHTML = '';
            let first = true;
            data.forEach(task => {
                if (task.is_visible !== false) {
     
                    const newTaskListItem = document.createElement('li');
                    newTaskListItem.classList.add('task-or-project-li');
                    const newTaskLink = document.createElement('p');
                    newTaskLink.className = 'task-or-project';
                    newTaskLink.textContent = task.name;
                    newTaskLink.dataset.totalSeconds = task.total_seconds;
                    newTaskLink.dataset.isCompleted = task.is_completed;

                    // Mark completed if is_complete
                    if (task.is_completed === true) {
                        newTaskLink.style.textDecoration = 'line-through';
                        newTaskListItem.setAttribute('data-completed', true);
                        newTaskListItem.style.height = '0px';
                        newTaskListItem.style.overflow = 'hidden';
                        newTaskListItem.style.margin = 'auto';
                    }
                    else {
                        newTaskLink.style.textDecoration = '';
                        newTaskListItem.setAttribute('data-completed', false);
                    }

                    // Make bold if it is the selected task
                    if (first) {
                        newTaskLink.style.opacity = '1';
                        newTaskLink.style.fontWeight = 'bold';
                    }
                    else {
                        newTaskLink.style.opacity = '0.5';
                        newTaskLink.style.fontWeight = 'normal';
                    }

                    newTaskLink.setAttribute('data-taskId', task.id);
                    newTaskListItem.appendChild(newTaskLink);
                    taskUlElement.appendChild(newTaskListItem);
                    calculateListHeight();

                    // Add click listener
                    addTaskClickListener(newTaskLink, task.id, task.name);

                    // Add hover listener
                    addHoverListener(newTaskLink, 'task', task.id);

                    // Populate logs if it's the first one
                    if (first===true){
                        if (globalTaskId!==task.id) {
                            populateLogs(task.id);
                        }
                        globalTaskId=task.id;
                        
                        first = false;

                        const logContent = document.getElementById('log-content');
                        const logDiv = document.getElementById('log-div');
                        logContent.style.visibility = 'visible';
                        logDiv.style.opacity = '1';
                    }
                }

            });
        }

        // Check cache first
        let cachedTasks = localStorage.getItem(`logs_cache_${projectId}`);
        if (cachedTasks) {
            console.log('tasks read from client-side cache');
            displayTaskData(JSON.parse(cachedTasks));
        }
        else {
            // Send projectId to /tasks endpoint
            fetch(`/tasks?project_id=${projectId}`)
            .then(response => response.json())
            .then(data => {
                displayTaskData(data);
                localStorage.setItem(`tasks_cache_${projectId}`, JSON.stringify(data));
            });           
        }
    }

    function makeLog(id, isPinned, date, description) {
        let dateObj;
        if (date !== null) {
            dateObj = new Date(date);
        }
        else {
            dateObj = new Date();
        }
        const localDateStr = dateObj.toLocaleString();
        const escapedLogText = description.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        let dark = '';
        let backgroundColor = '#161616';
        let color = 'var(--primary-color)';

        if (isPinned) { 
            dark = 'dark';
            color = '#161616';
            backgroundColor = 'var(--primary-color)';
        }

        const logEntry = `
            <div class="log-item" data-logId="${id}" data-isPinned=${isPinned} style="background-color:${backgroundColor}; color: ${color}">
                <div style="display: flex; margin-bottom: 5px; align-items: center;">
                    <div class="log-options-div">
                        <i id="pin-option-button" class="log-option-button ${dark} pin fa-solid fa-thumbtack" style="width: 0px; font-size: 10pt; overflow: hidden;"></i>
                        <i id="edit-option-button" class="log-option-button ${dark} fa fa-pencil-alt" style="width: 0px; font-size: 10pt; overflow: hidden;"></i>
                    </div>
                    <span class="log-created-at">${localDateStr}</span>
                </div>
                <span class="log-description" style="white-space: pre-line;">${escapedLogText}</span>
            </div>`;

        const element = document.createElement('div');
        element.innerHTML = logEntry;
        logItem = element.firstElementChild;
        addLogClickListener(logItem);

        const pinOption = logItem.querySelector('#pin-option-button');
        const editOption = logItem.querySelector('#edit-option-button');
        addLogPinClickListener(pinOption, logItem);
        addLogEditClickListener(editOption, logItem);
        return logItem;
    }

    function addLogPinClickListener(logOptionButton, logItem) {
        logOptionButton.addEventListener('click', () => pinLog(logItem));
    }
    function addLogEditClickListener(logOptionButton, logItem) {
        logOptionButton.addEventListener('click', () => editLog(logItem));
    }

    // GET from /tasks /hours and /logs endpoints and populate content
    function populateLogs(taskId) {

        const logItemsContainer = document.getElementById('log-items-container');
        logItemsContainer.innerHTML = '';

        const pinnedLogsContainer = document.getElementById('pinned-logs-container');
        pinnedLogsContainer.innerHTML = '';
        
        const taskName = document.getElementById('task-name');
        const taskCheckbox = document.getElementById('task-checkbox');

        let thisTask = document.querySelector(`p[data-taskid="${taskId}"]`);
        taskName.textContent = thisTask.textContent;
        globalSeconds = thisTask.dataset.totalSeconds;
        taskIsCompleted = thisTask.dataset.isCompleted;
        updateClock();

        if (taskIsCompleted === "true") {
            taskName.style.textDecoration = 'line-through';
            taskCheckbox.checked = true;
        }
        else {
            taskName.style.textDecoration = '';
            taskCheckbox.checked = false;
        }

        function displayLogData(data) {
            // Append responses to entry log
            data.forEach((log, index) => {
                showIt = (log.description.includes("Timer stop (") || log.description.includes("Timer start (") || log.description.includes("Timer edited to (")) ? false : true;
                if (showIt) {

                    let logEntry = makeLog(log.id, false, log.created_at, log.description);
                    let pinnedLogEntry = makeLog(log.id, true, log.created_at, log.description);
                    
                    if (log.is_pinned) {
                        pinnedLogsContainer.appendChild(pinnedLogEntry);
                        logEntry.style.height = '0px';
                        logEntry.style.padding = '0px';
                        logItemsContainer.appendChild(logEntry);
                    }
                    else{
                        logItemsContainer.appendChild(logEntry);
                    }
                    //adjustLogItemsContainerHeight();
                }
            });
            
        }

        // Check cache first
        let cachedLogs = localStorage.getItem(`logs_cache_${taskId}`);
        if (cachedLogs) {
            console.log('logs read from client-side cache');
            displayLogData(JSON.parse(cachedLogs));
        }
        else {
            fetch(`/logs?task_id=${taskId}`)
            .then(response => response.json())
            .then(data => {
                displayLogData(data);
                localStorage.setItem(`logs_cache_${taskId}`, JSON.stringify(data));
            })
        }     
    }

    // GET to /time endpoint
    function getTime(projectId) {
        timeDiv.innerHTML = '';

        function displayTimeData(data) {
            const totalDuration = data.reduce((sum, time) => sum + time.duration, 0);
            data.forEach((time, index) => {

                const newBlock = document.createElement('div');
                const widthPercent = totalDuration > 0 ? (time.duration * 100 / totalDuration) : 0;
                newBlock.className = 'time-block';
                newBlock.dataset.id = time.id;
                newBlock.dataset.taskId = time.task_id;
                newBlock.dataset.startTime = convertUTCToLocalForInput(time.start); 
                newBlock.dataset.endTime = convertUTCToLocalForInput(time.end);   
                newBlock.dataset.duration = time.duration;
                newBlock.dataset.taskName = time.task_name;
                newBlock.style.width = `0px`;
                newBlock.addEventListener('click', () => openTimeDescription(newBlock));
                newBlock.addEventListener('click', () => hideCommitTimeButton());
                timeDiv.appendChild(newBlock);
                setTimeout(() => {
                    newBlock.style.width = `${widthPercent}%`;
                }, 200);
            });

            resizeTimeBlocks();
        }

        let cachedTime = localStorage.getItem(`time_cache_${projectId}`);

        if (cachedTime) {
            console.log('time read from client-side cache');
            displayTimeData(JSON.parse(cachedTime));
        }
        else {
            fetch(`/time?project_id=${projectId}`, {credentials: "include"}) 
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                try {
                    localStorage.setItem(`time_cache_${projectId}`, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving data to LocalStorage:', e);
                }
                
                displayTimeData(data);
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
        }
    }

    // Function to convert a UTC date string to a local date string for the datetime-local input
    function convertUTCToLocalForInput(utcDateString) {
        const utcDate = new Date(utcDateString + 'Z'); // Ensure the 'Z' is there to parse as UTC
        const localDate = new Date(utcDate.getTime() - (utcDate.getTimezoneOffset() * 60000));
        return localDate.toISOString().slice(0, 16);
    }

    // Make it readable
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        let hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours.toString().padStart(2, '0') : '12'; 
        
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        
        return `${month}/${day} at ${hours}:${minutes} ${ampm}`;
    }

    // Add click listeners
    const timeDiv = document.getElementById('time-div');
    const timeContent = document.getElementById('time-content');
    const timeDescription = document.getElementById('time-description');
    const timeDescriptionContainer = document.getElementById('time-description-container');
    let activeBlock = null;

    function updateTimeDescription(block) {
        const duration = document.getElementById('duration');
        const blockDuration = block.dataset.duration; 
        const hours = (blockDuration / 60 / 60).toFixed(2);
        duration.textContent = hours;

        const timeDescriptionTaskName = document.getElementById('time-description-task-name'); 
        timeDescriptionTaskName.textContent = block.dataset.taskName;

        const startTimeInput = document.getElementById('start-time-input');
        startTimeInput.value = block.dataset.startTime;

        const endTimeInput = document.getElementById('end-time-input');
        endTimeInput.value = block.dataset.endTime;
    }

    function openTimeDescription(block) {
        let timeDescriptionHeight = timeDescription.offsetHeight;
        const timeBlocks = document.querySelectorAll('.time-block');
            timeBlocks.forEach(function(b) {
                b.style.backgroundColor = 'var(--primary-color)';
                b.style.opacity = "0.3";
                b.style.borderRadius = '5px';
            });

        // If click on new time block
        if (activeBlock !== block) {
                if (activeBlock) {
                    if (activeBlock.dataset.id === "-1") {
                        blockToRemove = activeBlock;
                        blockToRemove.style.width = '0px';
                        timeDiv.removeChild(blockToRemove);
                        resizeTimeBlocks();            
                    }
                    timeDescriptionContainer.style.height = '0px';
                    timeDescriptionContainer.style.opacity = '0.7';
                    block.style.opacity = "1";
                    block.style.backgroundColor = 'var(--primary-color)';
                    activeBlock = block;
                    timeDiv.style.borderRadius = '7px 7px 0 0';
                    block.style.borderRadius = '5px 5px 0 0';
                    updateTimeDescription(block);
                    timeDescriptionHeight = timeDescription.offsetHeight;
                    timeDescriptionContainer.style.height = `${timeDescriptionHeight}px`;
                    setTimeout(() => timeDescriptionContainer.style.opacity = '1', 100);

                } else {
                    addTimeBlockButton.removeEventListener('click', createTimeBlock);
                    addTimeBlockButton.style.width = '0px';
                    block.style.opacity = "1";
                    block.style.backgroundColor = 'var(--primary-color)';
                    activeBlock = block;
                    timeDiv.style.borderRadius = '7px 7px 0 0';
                    block.style.borderRadius = '5px 5px 0 0';
                    updateTimeDescription(block);
                    timeDescriptionHeight = timeDescription.offsetHeight;
                    timeDescriptionContainer.style.height = `${timeDescriptionHeight}px`;
                }
        } 
        // If click on active block
        else {
            closeTimeDescription() 
        }
    }

    function closeTimeDescription() {
        if (activeBlock && activeBlock.dataset.id === "-1") {
            blockToRemove = activeBlock;
            blockToRemove.style.width = '0px';
            timeDiv.removeChild(blockToRemove);
            resizeTimeBlocks();
        }

        const timeBlocks = document.querySelectorAll('.time-block');
        addTimeBlockButton.addEventListener('click', createTimeBlock);
        addTimeBlockButton.style.width = '16px';
        timeDescriptionHeight = timeDescription.offsetHeight;
        timeBlocks.forEach(function(b) {
            b.style.opacity = "1";
            b.style.backgroundColor = 'var(--primary-color)';
            b.style.borderRadius = '5px';
        });
        timeDescriptionContainer.style.height = '0px';
        timeDiv.style.borderRadius = '7px';
        activeBlock = null;
    }
    document.getElementById('project-space').addEventListener('click', function(event) {
        if (!timeContent.contains(event.target)) {
            closeTimeDescription();
        }
    });
    // POST to /projects endpoint and append list
    function addProject() {
        const projectUlElement = document.getElementById('project-list-ul');
        const newProjectLi = document.getElementById('new-project-li');
        const newProjectInput = document.getElementById('new-project-input');
        const newProjectName = newProjectInput.value;

        if (newProjectName) {

            // Create and insert the new list item before the input item
            const newListItem = document.createElement('li');
            newListItem.classList.add('task-or-project-li');
            const newLink = document.createElement('p');
            newLink.className = 'task-or-project';
            newLink.textContent = newProjectName;
            newListItem.setAttribute('data-completed', false);

            newListItem.appendChild(newLink);
            projectUlElement.insertBefore(newListItem, newProjectLi);
            newProjectInput.value = '';

            // Construct payload
            const payload = {
                name: newProjectName,
                user_id: globalUserId
            };

            // Send POST request to Flask API
            fetch('/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json())
            .then(data => {
                if (data.message === "Project created") {
                    console.log('project Created');
                    newLink.setAttribute('data-projectid',data.id)
                    addProjectClickListener(newLink, data.id, newProjectName);
                    addHoverListener(newLink, 'project', data.id);
                    localStorage.removeItem(`projects_cache_${globalUserId}`);
                }
            });
        }
    }

    // POST to /tasks endpoint and append list
    function addTask(projectId) {
        const newTaskLi = document.getElementById('new-task-li');
        const newTaskInput = document.getElementById('new-task-input');
        const newTaskName = newTaskInput.value;
        const taskUlElement = document.getElementById('task-list-ul');
        const logDiv = document.getElementById('log-div');

        if (newTaskName) {
            const newListItem = document.createElement('li');
            newListItem.classList.add('task-or-project-li');
            const newLink = document.createElement('p');
            newLink.className = 'task-or-project';
            newLink.textContent = newTaskName;
            newListItem.setAttribute('data-completed', false);

            newListItem.appendChild(newLink);
            taskUlElement.insertBefore(newListItem, newTaskLi);
            newTaskInput.value = '';
            newLink.setAttribute('data-total-Seconds', 0);
            newLink.setAttribute('data-is-Completed','false');

            // Construct payload
            const payload = {
                projectId: projectId,
                taskName: newTaskName
            };

            // Send POST request to Flask API
            fetch('/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json())
            .then(data => {
                if (data.message === "Task created") {
                    // Create and insert the new list item before the input item
                    console.log('task Created');
                    newLink.setAttribute('data-taskId', data.id);
                    addTaskClickListener(newLink, data.id, data.name);
                    addHoverListener(newLink, 'task', data.id);
                    localStorage.removeItem(`tasks_cache_${projectId}`);
                }
            });
        }
    }

    // POST to /logs endpoint and append list. PUT to /tasks
    function addLog(taskId, logType) {
        const logItemsContainer = document.getElementById('log-items-container');
        const tempId = Math.floor(Math.random() * 90000) + 10000;
        const initialTaskId = taskId;
        let isTimer = true;
        const logInput = document.getElementById('log-input');
        const clock = document.getElementById('clock');
        let logText;
        let logEntry;
        
        if (logType === "Start") {
            logText = `Timer start (${clock.textContent})`;
        }
        else if (logType === "Stop") {
            logText = `Timer stop (${clock.textContent})`;
        }
        else if (logType === "Edit") {
            logText = `Timer edited to (${clock.textContent})`;
        }
        else {
            logText = logInput.value;
            isTimer = false;

            // Build log entry
            logEntry = makeLog(tempId, false, null, logText);
            logItemsContainer.insertBefore(logEntry, logItemsContainer.childNodes[1]);
            addLogClickListener(logEntry);
        }

        // construct PUT payload
        const putPayload = {
            taskId: taskId,
            totalSeconds: globalSeconds
        };

        // Send PUT request to Flask API
        fetch('/tasks', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(putPayload)
        }).then(response => response.json())
        .then(data => {
            if (data.message === "Task updated") {
                console.log("task updated")
            }
        });

        if (taskId) {
            // Construct POST payload
            const postPayload = {
                taskId: taskId,
                description: logText,
                createdAt: new Date()
            };

            // Send POST request to Flask API
            fetch('/logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postPayload)
            }).then(response => response.json())
            .then(data => {
                if (data.message === "Log created") {
                    logEntry.setAttribute('data-logid',data.id);
                    localStorage.removeItem(`logs_cache_${taskId}`);
                }
            });

        }
    }

    // Add a click listener to a project link
    function addProjectClickListener(newLink, projectId, projectName) {
        newLink.addEventListener('click', function() {

            // Stop clock if running
            const toggleIcon = document.getElementById('toggle-icon');
            if (toggleIcon.classList.contains('fa-hourglass-half')) {
                toggleClock();
            }

            // Show tasks
            if (projectId !== globalProjectId){
                globalTaskId = undefined;
                populateTasks(projectId);
                timeDescriptionContainer.style.height = '0px';
                getTime(projectId);
            }
            
            // Fade log if picking a new project
            const logContent = document.getElementById('log-content');
            const logDiv = document.getElementById('log-div');
            if (globalProjectId !== projectId) {
                logContent.style.visibility = 'hidden';
                logDiv.style.opacity = "1";
            }

            // Update global
            globalProjectId = projectId;

            // Update project name label
            const projectNameLabel = document.getElementById('project-name');
            projectNameLabel.textContent = projectName;
            
            const allLinks = document.querySelectorAll('#project-list-ul li p');
            allLinks.forEach(link => {
                link.style.fontSize = '12pt';
                link.style.opacity = '0.5';
                link.style.fontWeight = 'normal';
            });
            newLink.style.fontWeight = 'bold';
            newLink.style.opacity = '1';

        });
    }

    // Add click event listener to task link
    function addTaskClickListener(newLink, taskId) {
        newLink.addEventListener('click', function() {
            calculateTaskTotalTime(taskId);

            // Stop clock if running
            const toggleIcon = document.getElementById('toggle-icon');
            if (toggleIcon.classList.contains('fa-hourglass-half') && taskId !== globalTaskId) {
                toggleClock();
                updateClock();
            }

            if (taskId!==globalTaskId) {
                // Show logs
                populateLogs(taskId);
                
                // Update global
                globalTaskId = taskId;
            }

            // Update bold
            const allLinks = document.querySelectorAll('#task-list-ul li p');
            allLinks.forEach(link => {
                link.style.opacity = '0.5';
                link.style.fontWeight = 'normal';
            });
            newLink.style.fontWeight = 'bold';
            newLink.style.opacity = '1';

        });
    }

    // Add click listener to log 
    function addLogClickListener(logItem) {
        logItem.addEventListener('dblclick', function(e) {
            console.log('');
        })
    }

    // Add unload listener
    window.addEventListener('beforeunload', function() {
        const toggleIcon = document.getElementById('toggle-icon');
        if (toggleIcon.classList.contains('fa-hourglass-half')) {
            toggleClock();
        }
    });

    // Add hover event listener to project link
    function addHoverListener(newLink, elementType, elementId) {
        let hoverMenu;
        let timeoutId;

        newLink.addEventListener('contextmenu', function(e) {
            event.preventDefault();

            // Remove existing hover menus
            const existingMenu = document.querySelector('.custom-hover-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // Create custom hover menu
            hoverMenu = document.createElement('ul');
            hoverMenu.className = 'custom-hover-menu';

            // Rename option with FontAwesome icon
            const renameOption = document.createElement('li');
            const renameIcon = document.createElement('i');
            renameIcon.className = 'fa fa-pencil-alt'; 
            renameOption.appendChild(renameIcon);

            renameOption.addEventListener('click', function() {
                // Hide hover menu
                hoverMenu.remove();

                // Create an input element
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = newLink.textContent;

                // Replace the link with the input element
                newLink.parentNode.replaceChild(inputElement, newLink);

                // Focus the input and select its content
                inputElement.focus();
                inputElement.select();

                // Revert changes if the user clicks away
                const blurHandler = function() {
                    if (inputElement.parentNode) {
                        inputElement.parentNode.replaceChild(newLink, inputElement);
                    }
                };
                inputElement.addEventListener('blur', blurHandler);

                // Listen for Enter key press
                inputElement.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        inputElement.removeEventListener('blur', blurHandler);
                        
                        if (elementType==='project') {
                            // Run renameProject function
                            renameProject(globalProjectId, inputElement.value);
                        }
                        else {
                            // Run renameTask function
                            renameTask(globalTaskId, inputElement.value);
                        }

                        // Replace the input back with the link
                        if (inputElement.parentNode) {
                            inputElement.parentNode.replaceChild(newLink, inputElement);
                        }

                        // Update the link text
                        newLink.textContent = inputElement.value;
                        
                    }
                });
            });

            // Complete option with FontAwesome icon
            const completeOption = document.createElement('li');
            const completeIcon = document.createElement('i');
            let isCompleted = true;

            if (newLink.style.textDecoration === 'line-through') {
                completeIcon.className = 'fa fa-undo';
                isCompleted = false;
            }
            else {
                completeIcon.className = 'fa fa-check';
            }
            
            completeOption.appendChild(completeIcon);
            completeOption.addEventListener('click', function() {

                if (completeIcon.className === 'fa fa-check') {
                    // Confetti
                    const x = event.clientX;
                    const y = event.clientY;
                    createConfetti(x, y);
                }

                if (elementType==='project'){
                    completeProject(globalProjectId, isCompleted);
                }
                else {
                    const taskCheckbox = document.getElementById('task-checkbox');
                    const taskLabel = document.getElementById('task-name');
                    completeTask(taskCheckbox, taskLabel, isCompleted);
                }
                
                // Remove the hover menu
                if (hoverMenu && hoverMenu.parentNode) {
                    hoverMenu.parentNode.removeChild(hoverMenu);
                }
            })
            
            // Delete option with FontAwesome icon
            let deleteConfirmed = false;  
            const deleteOption = document.createElement('li');
            const deleteIcon = document.createElement('i');
            deleteIcon.className = 'fa fa-trash';  // FontAwesome class for trash/delete icon
            deleteOption.appendChild(deleteIcon);

            deleteOption.addEventListener('click', function() {
                if (!deleteConfirmed) {
                    // First click: Ask for confirmation
                    deleteIcon.className = 'fa fa-question';  // Change to a 'confirm' icon
                    deleteConfirmed = true;
                } else {
                    // Second click: Proceed with deletion
                    if (elementType==='project') {
                        deleteProject(globalProjectId);
                        const taskList = document.getElementById('task-list-ul');
                        taskList.innerHTML = "";
                    }
                    else {
                        deleteTask(globalTaskId);
                    }

                    // Remove the hover menu
                    if (hoverMenu && hoverMenu.parentNode) {
                        hoverMenu.parentNode.removeChild(hoverMenu);
                    }

                    deleteConfirmed = false;  // Reset flag
                }
            });

            // Append options to hover menu
            hoverMenu.appendChild(completeOption);
            hoverMenu.appendChild(renameOption);
            hoverMenu.appendChild(deleteOption);

            // Append hover menu to document
            document.body.appendChild(hoverMenu);

            // Position the hover menu to the right of the list item
            const rect = newLink.getBoundingClientRect();
            hoverMenu.style.top = (rect.top + window.scrollY) + 'px';
            hoverMenu.style.left = (rect.right + window.scrollX) + 'px';


            // Clear any existing timeout
            if (timeoutId) {
                clearTimeout(timeoutId);
            }

            hoverMenu.addEventListener('mouseleave', function() {
                // Set a timeout to fade out the menu after 1 second
                timeoutId = setTimeout(() => {
                    hoverMenu.classList.add('fade-out');
                    setTimeout(() => {
                        hoverMenu.remove();
                    }, 300);  // Remove after the transition completes
                }, 300);
            });

            hoverMenu.addEventListener('mouseenter', function() {
                // Clear the timeout and fade-out class if the mouse re-enters the menu
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                hoverMenu.classList.remove('fade-out');
            });

        });

        newLink.addEventListener('mouseleave', function(e) {
            // If the menu exists and isn't hovered, set a timeout to remove it
            if (hoverMenu && !hoverMenu.matches(':hover')) {
                hoverMenu.classList.add('fade-out');
                timeoutId = setTimeout(() => {
                    hoverMenu.remove();
                }, 300);
            }
        });
    }

    // Update clock
    let currentRotation = 0;
    let clockStartTime = null;
    function updateClock(countUp) {
        const button = document.querySelector('.button-common');
        const projectSpace = document.getElementById('project-space');
        if (countUp === true) {
            currentRotation = 180;
        }

        if (countUp === true && clockStartTime === null) {
            clockStartTime = new Date().getTime() - (globalSeconds * 1000);
        }

        if (clockStartTime !== null) {
            const currentTime = new Date().getTime();
            globalSeconds = Math.floor((currentTime - clockStartTime) / 1000);
        }
    
        const hrs = String(Math.floor(globalSeconds / 3600)).padStart(2, '0');
        const mins = String(Math.floor((globalSeconds % 3600) / 60)).padStart(2, '0');
        const secs = String(globalSeconds % 60).padStart(2, '0');
        clock.textContent = `${hrs}.${mins}.${secs}`;
    }

    // Handle clock edit
    function makeEditable() {
        // Convert current time to editable format
        let currentText = this.innerText;
        let input = document.createElement('input');
        input.value = currentText;
        input.className = 'rename-input darkmode';
        this.replaceWith(input);
        
        // Focus and select the input content
        input.focus();
        input.select();

        // Add event listener for blur and key events
        input.addEventListener('blur', processEdit);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                processEdit.call(this, e);
            }
        });
    }
    function processEdit(e) {
            this.removeEventListener('blur', processEdit);
            this.removeEventListener('keydown', processEdit);
            let value = e.target.value;
            let newClock = document.createElement('p');
            newClock.id = 'clock';
            newClock.addEventListener('click', makeEditable);
            if (isValidTime(value)) {
                let seconds = convertToSeconds(value);
                globalSeconds = seconds;
                newClock.textContent = value;
                e.target.replaceWith(newClock);
                addLog(globalTaskId, 'Edit');
            }
    }
    function isValidTime(time) {
        let regex = /^([0-9]{2}\.){2}[0-9]{2}$/;
        return regex.test(time);
    }
    function convertToSeconds(time) {
        let [hours, minutes, seconds] = time.split('.').map(Number);
        return hours * 3600 + minutes * 60 + seconds;
    }


    // Play pause toggle
    let toggleClock = (function() {
        const button = document.querySelector('.button-common');
        const toggleIcon = document.getElementById('toggle-icon');
        const clockDiv = document.getElementById('clock-div');

        let timerStartDateTime = null;
        let timerDuration = 0;
        let intervalId = null;

        return function() {
            if (toggleIcon.classList.contains('fa-hourglass-end')) {
                    clockDiv.classList.add('fade-in-animation');
                    updateClock(true);
                    timerDuration = 0;
                    timerStartDateTime = new Date();
                    button.style.transform = `rotate(180deg)`;
                    toggleIcon.classList.remove('fa-hourglass-end');
                    toggleIcon.classList.add('fa-hourglass-half');
                    intervalId = setInterval(() => {
                        timerDuration++; 
                        updateClock(true);
                    }, 1000);
                } else {
                    clockDiv.classList.remove('fade-in-animation');
                    clockStartTime = null;
                    toggleIcon.classList.remove('fa-hourglass-half');
                    toggleIcon.classList.add('fa-hourglass-end');
                    clearInterval(intervalId);
                    button.style.transform = `rotate(${currentRotation-180}deg)`;
                    currentRotation = 0;
                    timerEndDateTime = new Date();
                    timerDuration = Math.floor((timerEndDateTime - timerStartDateTime) / 1000);

                    newBlock = document.createElement('div');
                    newBlock.className = 'time-block';
                    newBlock.dataset.startTime = convertUTCToLocalForInput(timerStartDateTime.toISOString().slice(0,16));
                    newBlock.dataset.endTime = convertUTCToLocalForInput(timerEndDateTime.toISOString().slice(0,16));
                    newBlock.dataset.duration = timerDuration;
                    newBlock.dataset.taskId = globalTaskId;
                    newBlock.dataset.taskName = document.getElementById('task-name').textContent;
                    newBlock.addEventListener('click', () => openTimeDescription(newBlock));
                    timeDiv.appendChild(newBlock);
                    resizeTimeBlocks();

                    // POST time block
                    const payload = {
                        projectId: globalProjectId,
                        taskId: globalTaskId,
                        start: timerStartDateTime,
                        end: timerEndDateTime,
                        duration: timerDuration
                    };

                    // Send POST request to Flask API
                    fetch('/time', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === "Time block created") {
                            console.log("time block updated")
                            newBlock.dataset.id = data.id;
                        }
                        localStorage.removeItem(`time_cache_${globalProjectId}`);
                    });
                    calculateTaskTotalTime(globalTaskId, changed=true);
                }
            };
    })();
    document.getElementById('clock').addEventListener('click', toggleClock);

    // Create a new time block on click
    addTimeBlockButton = document.getElementById('add-a-time-block');
    function createTimeBlock() {
        newBlock = document.createElement('div');
        newBlock.className = 'time-block';
        newBlock.dataset.duration = 3600;
        timerStartDateTime = new Date();
        timerEndDateTime = new Date();
        timerStartDateTime.setSeconds(timerEndDateTime.getSeconds() - parseInt(newBlock.dataset.duration));
        newBlock.dataset.startTime = convertUTCToLocalForInput(timerStartDateTime.toISOString().slice(0,16));
        newBlock.dataset.endTime = convertUTCToLocalForInput(timerEndDateTime.toISOString().slice(0,16));
        newBlock.dataset.duration = 3600;
        newBlock.dataset.id = -1;
        newBlock.dataset.taskId = globalTaskId;
        newBlock.dataset.taskName = document.getElementById('task-name').textContent;
        newBlock.addEventListener('click', () => openTimeDescription(newBlock));
        timeDiv.appendChild(newBlock);
        openTimeDescription(newBlock);
        resizeTimeBlocks();
        newBlock.style.backgroundColor = 'transparent';
        newBlock.style.border = '2px dashed var(--primary-color)';
        showCommitTimeButton(endTimeInput);
    }
    addTimeBlockButton.addEventListener('click', createTimeBlock);

    // Resize time blocks
    function resizeTimeBlocks() {
        const timeBlocks = document.querySelectorAll(".time-block");
        const today = new Date();
        const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());

        let totalDuration = 0;
        let totalDurationToday = 0;

        timeBlocks.forEach(block => {
            totalDuration += parseInt(block.dataset.duration, 10);

            if (Date.parse(block.dataset.startTime) >= startOfToday && Date.parse(block.dataset.startTime) < new Date(startOfToday).setDate(startOfToday.getDate() + 1)) {
                totalDurationToday += parseInt(block.dataset.duration, 10);
            }
        });

        const hoursLogged = document.getElementById('hours-logged');
        hoursLogged.textContent = `${(totalDuration / 60 / 60).toFixed(2)} hours logged, ${(totalDurationToday / 60 / 60).toFixed(2)} today`;

        timeBlocks.forEach(block => {
            let duration = parseInt(block.dataset.duration, 10);
            let widthPercentage = (duration / totalDuration) * 100;
            block.style.width = widthPercentage + '%';
            if (block.offsetWidth < 35) {
                block.style.color = 'var(--primary-color)';
            }
            else {
                block.style.color = '#161616';
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Toggle on click
        const toggleButton = document.getElementById('toggle-button');
        toggleButton.addEventListener('click', function() {
            toggleClock();
        })

        // Add log upon enter
        const logInput = document.getElementById('log-input');
        logInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    e.preventDefault(); 

                    const cursorPosition = logInput.selectionStart;
                    const textBeforeCursor = logInput.value.substring(0, cursorPosition);
                    const textAfterCursor = logInput.value.substring(cursorPosition);

                    logInput.value = textBeforeCursor + '\n' + textAfterCursor;
                    logInput.selectionStart = cursorPosition + 1;
                    logInput.selectionEnd = cursorPosition + 1;
                } else {
                    e.preventDefault();
                    addLog(globalTaskId, logType='Comment');
                    logInput.value = '';
                }
            }
        });


        // Mark task as completed or not yet completed when taskbox is checked
        const taskCheckbox = document.getElementById('task-checkbox');
        const taskLabel = document.getElementById('task-name');

        taskCheckbox.addEventListener('click', function(event) {
            const isCompleted = taskCheckbox.checked ? true : false;
            completeTask(taskCheckbox, taskLabel, isCompleted);

            if (isCompleted === true) {
                // Confetti
                const x = event.clientX;
                const y = event.clientY;
                createConfetti(x, y);
            }

            const toggleIcon = document.getElementById('toggle-icon');
            if (toggleIcon.classList.contains('fa-hourglass-half')){
                toggleClock();
            }
        });
    });

    // Complete task
    function completeTask(taskCheckbox, taskLabel, isCompleted) {
        const selectedTask = document.querySelector(`p[data-taskId="${globalTaskId}"]`);
        const listItem = selectedTask.closest('li');

        if (isCompleted) {
            selectedTask.style.textDecoration = 'line-through';
            taskLabel.style.textDecoration = 'line-through';
            taskCheckbox.checked = true;
            listItem.setAttribute('data-completed',true);
            listItem.style.height = '0px'
            listItem.style.height = '0px';
            listItem.style.overflow = 'hidden';
            listItem.style.margin = 'auto';
        }
        else {
            selectedTask.style.textDecoration = '';
            taskLabel.style.textDecoration = '';
            taskCheckbox.checked = false;
            listItem.setAttribute('data-completed',false);
            listItem.style.height = 'auto';
            listItem.style.overflow = 'visible';
            listItem.style.marginBottom = '5px';
        }

        calculateListHeight();

        fetch(`/tasks`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: globalTaskId,
                isCompleted: isCompleted,
                totalSeconds: globalSeconds
            })
            })
            .catch(error => {
            console.error(error);
        });

        localStorage.removeItem(`tasks_cache_${globalProjectId}`);

    }

    // Complete project
    function completeProject(projectId, isCompleted) {
        const selectedProject = document.querySelector(`p[data-projectId="${globalProjectId}"]`);
        const listItem = selectedProject.closest('li');
        
        if (isCompleted) {
            selectedProject.style.textDecoration = 'line-through';
            listItem.setAttribute('data-completed',true);
            listItem.style.height = '0px'
            listItem.style.height = '0px';
            listItem.style.overflow = 'hidden';
            listItem.style.margin = 'auto';
        }
        else {
            selectedProject.style.textDecoration = '';
            listItem.setAttribute('data-completed',false);
            listItem.style.height = 'auto';
            listItem.style.overflow = 'visible';
            listItem.style.marginBottom = '5px';
        }

        calculateListHeight();

        fetch(`/projects`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                isCompleted: isCompleted
            })
            })
            .then(response => response.json())
            .then(data => {
                //populateProjects();
                localStorage.removeItem(`projects_cache_${globalUserId}`);
            })
            .catch(error => {
            console.error(error); // Handle errors
        }); 
    }

    // Rename project
    function renameProject(projectId, newName){
        localStorage.removeItem(`projects_cache_${globalUserId}`);

        fetch(`/projects`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                name: newName
            })
            })
            .then(response => response.json())
            .then(data => {
                populateProjects();
            })
            .catch(error => {
                console.error(error); 
        });
    }

    // Delete project
    function deleteProject(projectId){
        localStorage.removeItem(`projects_cache_${globalUserId}`);
        fetch(`/projects`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                isVisible: false
            })
            })
            .then(response => response.json())
            .then(data => {
                populateProjects();
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Rename task
    function renameTask(taskId, newName){
        localStorage.removeItem(`tasks_cache_${globalProjectId}`);
        fetch(`/tasks`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                name: newName,
                totalSeconds: globalSeconds
            })
            })
            .then(response => response.json())
            .then(data => {
                const taskLabel = document.getElementById('task-name');
                taskLabel.textContent = newName;
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Delete task
    function deleteTask(taskId){
        localStorage.removeItem(`tasks_cache_${globalProjectId}`);
        fetch(`/tasks`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                isVisible: false,
                totalSeconds: globalSeconds
            })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Task updated") {
                    const logDiv = document.getElementById('log-div');
                    const logContent = document.getElementById('log-content');
                    globalTaskId=undefined;
                    populateTasks(globalProjectId);
                }
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Pin log
    function pinLog(logItem) {
        localStorage.removeItem(`logs_cache_${globalTaskId}`);

        const logItemsContainer = document.getElementById('log-items-container');
        const pinnedLogsContainer = document.getElementById('pinned-logs-container');

        const logId = logItem.getAttribute('data-logId');
        const isPinned = logItem.getAttribute('data-isPinned');

        if (logItem) {
            if (isPinned === 'true') {
                // Unpin if pinned
                hiddenLogItem = logItemsContainer.querySelector(`[data-logId="${logId}"]`);
                hiddenLogItem.style.height = 'auto';
                hiddenLogItem.style.padding = '15px';

                // Make sure the text content is updated
                const hiddenDescription = hiddenLogItem.querySelector('.log-description');
                const pinnedDescription = logItem.querySelector('.log-description');
                hiddenDescription.textContent = pinnedDescription.textContent;
                pinnedLogsContainer.removeChild(logItem);
            } else {
                // Pin if not pinned
                let clonedLogItem = logItem.cloneNode(true);
                
                // Make buttons dark
                const logOptionButtons = clonedLogItem.querySelectorAll('.log-option-button');
                logOptionButtons.forEach(button => {
                    button.classList.add('dark')
                });

                // Hide item in regular log
                logItem.style.height = '0px';
                logItem.style.padding = '0px';
                logItem.style.overflow = 'hidden';

                // Create item in pinned log
                clonedLogItem.style.opacity = '1'; 
                clonedLogItem.style.background = 'var(--primary-color)';
                clonedLogItem.style.color = '#161616';
                pinnedLogsContainer.appendChild(clonedLogItem);
                clonedLogItem.setAttribute('data-isPinned', 'true');
                addLogClickListener(clonedLogItem);

                const pinOption = clonedLogItem.querySelector('#pin-option-button');
                const editOption = clonedLogItem.querySelector('#edit-option-button');
                addLogPinClickListener(pinOption, clonedLogItem);
                addLogEditClickListener(editOption, clonedLogItem)
            }
        }

        // Update log
        fetch(`logs`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: globalTaskId,
                logId: logId,
                isPinned: isPinned !== 'true'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Log updated") {
                console.log('log updated');
            }
        });
    }

    function editLog(logItem) {
        const logDescription = logItem.querySelector('.log-description');
        const editOption = logItem.querySelector('#edit-option-button');
        const inputElement = document.createElement('textarea');
        
        inputElement.classList.add('log-edit-area');
        if (logItem.getAttribute('data-isPinned') === 'true') {
            inputElement.classList.add('dark');
        }

        const description = logDescription.textContent;
        inputElement.value = description;
        editOption.style.display = 'none';

        // Replace the description with the input element
        logDescription.parentNode.replaceChild(inputElement, logDescription);

        // Focus the input and select its content
        inputElement.focus();
        inputElement.select();

        // Function to revert changes
        function revertEdit() {
            if (inputElement.parentNode) {
                inputElement.parentNode.replaceChild(logDescription, inputElement);
                inputElement.removeEventListener('keydown', escHandler); 
                editOption.style.display = 'inline-block';
            }
        }

        // Function to handle escape key
        function escHandler(event) {
            if (event.key === 'Escape') {
                revertEdit();
            }
        }

        // Add event listener for the escape key
        inputElement.addEventListener('keydown', escHandler);

        // Function to commit changes
        function commitLogEdit() {
            const newDescription = inputElement.value;
            logDescription.textContent = newDescription;

            if (inputElement.parentNode) {
                inputElement.parentNode.replaceChild(logDescription, inputElement);
                inputElement.removeEventListener('keydown', enterHandler); 
                editOption.style.display = 'inline-block';

                // Update log
                fetch(`logs`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: globalTaskId,
                        logId: logItem.getAttribute('data-logId'),
                        newDescription: newDescription
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Log updated") {
                        console.log('log updated');
                        localStorage.removeItem(`logs_cache_${globalTaskId}`);
                    }
                });
            }
        }

        // Function to handle enter key
        function enterHandler(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    event.preventDefault(); 

                    const cursorPosition = inputElement.selectionStart;
                    const textBeforeCursor = inputElement.value.substring(0, cursorPosition);
                    const textAfterCursor = inputElement.value.substring(cursorPosition);

                    inputElement.value = textBeforeCursor + '\n' + textAfterCursor;
                    inputElement.selectionStart = cursorPosition + 1;
                    inputElement.selectionEnd = cursorPosition + 1;
                }
                else {
                    commitLogEdit();
                }
            }
        }

        inputElement.addEventListener('keydown', enterHandler);
    }


    // Add click listeners to export buttons
    const projectExport = document.getElementById('project-csv');
    projectExport.addEventListener('click', function() {
        exportCsv('user_id',globalUserId);
    })
    const taskExport = document.getElementById('task-csv');
    taskExport.addEventListener('click', function() {
        exportCsv('project_id',globalProjectId);
    })
    const logExport = document.getElementById('log-csv');
    logExport.addEventListener('click', function() {
        exportCsv('task_id',globalTaskId);
    })
    const timeExport = document.getElementById('time-csv');
    timeExport.addEventListener('click', function() {
        exportCsv('time',globalProjectId);
    })


    // Ping export backend
    function exportCsv(arg, id) {
        // Generate filename based on arg
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');

        let prefix = 'anolog_';

        let dataType = '';
        if (arg === 'user_id') {
            dataType = 'projects';
        } else if (arg === 'project_id') {
            dataType = 'tasks';
        } else if (arg === 'task_id') {
            dataType = 'logs';
        } else if (arg === 'time') {
            dataType = 'time';
        }

        const filename = `${prefix}${dataType}_${year}${month}${day}${hour}${minute}`;

        // Fetch CSV data and trigger download
        fetch(`/export_csv?${arg}=${id}`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${filename}.csv`;  // Use the dynamically generated filename
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error:', error));
    }

    // Collapse left menu
    document.querySelector('.toggle').addEventListener('click', function() {
        const listContainer = document.querySelector('.list-container')
        const menuButton = document.getElementById('menu-button');
        if (menuButton.className === "fa-solid fa-bars") {
            listContainer.classList.remove('list-collapsed');
            menuButton.className = "fa-solid fa-square-minus";
            setTimeout(resizeTimeBlocks,150);
        }
        else {          
            listContainer.classList.add('list-collapsed');
            void listContainer.offsetWidth;
            menuButton.className = "fa-solid fa-bars";
            setTimeout(resizeTimeBlocks,150);
        }
    });

    // Open export menu
    const exportButton = document.getElementById('export-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    function addBorderRadius() {
        exportButton.style.borderRadius = '10px 10px 0 0';
        exportButton.style.width = '80px';
    }
    function removeBorderRadius() {
        exportButton.style.borderRadius = '10px';  
        exportButton.style.width = '40px';
    }
    exportButton.addEventListener('mouseover', addBorderRadius);
    exportButton.addEventListener('mouseout', removeBorderRadius);
    dropdownMenu.addEventListener('mouseover', addBorderRadius);
    dropdownMenu.addEventListener('mouseout', removeBorderRadius);

    // Collapse menu only on mobile
    const listContainer = document.querySelector('.list-container');
    const menuButton = document.getElementById('menu-button');
    function setClassForScreenSize() {
        if (window.innerWidth >= 769) {
            listContainer.classList.remove('list-collapsed');
            menuButton.className = "fa-solid fa-square-minus";
            resizeTimeBlocks();
        } else {
            listContainer.classList.add('list-collapsed');
            menuButton.className = "fa-solid fa-bars";
            resizeTimeBlocks();
        }
    }

    window.addEventListener('resize', calculateListHeight);
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        calculateListHeight();
        resizeTimeout = setTimeout(resizeTimeBlocks, 100);
        setClassForScreenSize();
    });
    
    // Pick color
    document.getElementById('picker-label').addEventListener('click', function() {
        document.getElementById('color-picker').click();
    });
    document.addEventListener('input', function(event) {
        if (event.target.id === 'color-picker') {
            document.documentElement.style.setProperty('--primary-color', event.target.value);
        }
    });

    // Update user's color field
    document.addEventListener('change', function(event) {
        if (event.target.id === 'color-picker') {
            document.documentElement.style.setProperty('--primary-color', event.target.value);
            updateFavicon(event.target.value);
            // Send PUT to /user endpoint
            fetch('/user', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({userId: globalUserId, color: event.target.value }),
            });
        }
    });

    // Confetti
    function createConfetti(x, y) {
        const confettiCount = 40;
        const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];

            for(let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.backgroundColor = randomColor;
                confetti.className = 'confetti';
                confetti.style.left = `${x}px`;
                confetti.style.top = `${y}px`;
                document.body.appendChild(confetti);

                // Randomize initial position and rotation
                confetti.style.setProperty('--initial-x', `${Math.random() * 30 - 15}px`);
                confetti.style.setProperty('--initial-y', `${Math.random() * 30 - 15}px`);
                confetti.style.setProperty('--rotation', `${Math.random() * 360}deg`);
                confetti.style.setProperty('--speed', `${Math.random() * .1 + 0.5}s`);

                // Remove after animation completes
                confetti.addEventListener('animationend', function() {
                confetti.remove();
                });
            }
    }

    // Logout 
    document.getElementById('logout-button').addEventListener('click', function() {
                        window.location.href = '/logout';
                    });

    // Toggle darkmode
    function toggleDarkmode(initialToggle) {
        const logo = document.querySelector('.logo');
        const title = document.querySelector('h1');
        const darkmodeIcon = document.querySelector('#darkmode-icon');

        if (initialToggle) {
            darkmode = !darkmode;
        }

        if (darkmode) {
            // Make lightmode
            darkmode = false;
            document.body.style.backgroundColor = "var(--primary-color)";
            darkmodeIcon.className = "fa-regular fa-moon";
            darkmodeIcon.style.fontSize = "14pt";
            title.style.color = "#161616";
            logo.style.background = "conic-gradient(transparent 0% 25%, #161616 25% 100%)";
        }
        else {
            // Make darkmode
            darkmode = true;
            document.body.style.backgroundColor = "#252525";
            darkmodeIcon.className = "fa-solid fa-moon";
            darkmodeIcon.style.fontSize = "14pt";
            title.style.color =  "var(--primary-color)";
            logo.style.background = "conic-gradient(transparent 0% 25%, var(--primary-color) 25% 100%)";
        }

        if (!firstLoad) {
        // Send PUT to /user endpoint
            fetch('/user', {
                method: 'PUT',
                headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify({userId: globalUserId, darkmode: darkmode }),
            });
        }
        firstLoad = false;
    }
    const darkmodeButton = document.querySelector('.darkmode-button');
    darkmodeButton.addEventListener('click', function() {
        toggleDarkmode();
    })
    toggleDarkmode(initialToggle=true);

    // Dynamically change icon
    function updateFavicon(color) {
        let faviconCanvas = createIconCanvas(color, 32, 0);
        updateLinkInHead('icon', faviconCanvas.toDataURL('image/x-icon'));

        let appleIconCanvas = createIconCanvas(color, 180, 40); 
        updateLinkInHead('apple-touch-icon', appleIconCanvas.toDataURL());
    }

    function createIconCanvas(color, size, padding) {
        let canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        let ctx = canvas.getContext('2d');

        let radius = (size / 2) - padding;
        ctx.beginPath();
        ctx.arc(size / 2, size / 2, radius, -0.5 * Math.PI, -2 * Math.PI, true);
        ctx.lineTo(size / 2, size / 2);
        ctx.fillStyle = color;
        ctx.fill();
        return canvas;
    }

    function updateLinkInHead(relValue, href) {
        let link = document.querySelector(`link[rel~='${relValue}']`);
        if (!link) {
            link = document.createElement('link');
            link.rel = relValue;
            document.getElementsByTagName('head')[0].appendChild(link);
        }
        link.href = href;
    }
    updateFavicon('{{ primary_color }}');

    // Toggle show completed
    function toggleShowCompleted(type) {
        let completed = document.querySelectorAll(`#${type}-list-ul li[data-completed=true]`);
        if (type === 'task') {
            showCompleted = showCompletedTasks;
        }
        else {
            showCompleted = showCompletedProjects;
        }
        completed.forEach(item => {
            if (showCompleted) {
                item.style.height = '0px';
                item.style.overflow = 'hidden';
                item.style.margin = 'auto';
            } else {
                item.style.height = 'auto';
                item.style.overflow = 'visible';
                item.style.marginBottom = '5px';
            }
        });
        if (type === 'task') {
            showCompletedTasks = !showCompletedTasks;
        }
        else {
            showCompletedProjects = !showCompletedProjects;
        }

    }
    const showCompletedTaskToggle = document.getElementById('toggle-completed-tasks');
    showCompletedTaskToggle.addEventListener('click', function() {
        toggleShowCompleted('task');
        if (showCompletedTasks) {
            showCompletedTaskToggle.className = 'toggle-completed fa-solid fa-eye';
            showCompletedTaskToggle.title = "Hide Completed Tasks";
        } else {
            showCompletedTaskToggle.className = 'toggle-completed fa-solid fa-eye-slash';
            showCompletedTaskToggle.title = "Hide Completed Tasks";
        }
    });
    const showCompletedProjectToggle = document.getElementById('toggle-completed-projects');
    showCompletedProjectToggle.addEventListener('click', function() {
        toggleShowCompleted('project');
        if (showCompletedProjects) {
            showCompletedProjectToggle.className = 'toggle-completed fa-solid fa-eye';
            showCompletedProjectToggle.title = "Hide Completed Projects";
        } else {
            showCompletedProjectToggle.className = 'toggle-completed fa-solid fa-eye-slash';
            showCompletedProjectToggle.title = "Hide Completed Projects";
        }
    });

    // Add a task or project
    function addNewItem(type) {
        calculateListHeight();
        const projectUlElement = document.getElementById('project-list-ul');
        const taskUlElement = document.getElementById('task-list-ul');
        const targetUl = type === 'project' ? projectUlElement : taskUlElement;

        const newLi = document.createElement('li');
        newLi.classList.add('task-or-project-li');
        newLi.id = `new-${type}-li`;

        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.id = `new-${type}-input`;

        newInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (type === 'project') {
                    addProject();
                } else if (type === 'task') {
                    addTask(globalProjectId);
                }
                newInput.focus();
                targetUl.removeChild(newLi);
            }
            calculateListHeight();
        });

        // Remove the input when it loses focus
        newInput.addEventListener('blur', function() {
            targetUl.removeChild(newLi);
        });

        newLi.appendChild(newInput);
        targetUl.insertBefore(newLi, targetUl.firstChild);
        newInput.focus();
    }

    document.querySelectorAll('.add-button').forEach(button => {
        button.addEventListener('click', function() {
            if (this.id === 'add-a-task') {
                addNewItem('task');
            } else if (this.id === 'add-a-project') {
                addNewItem('project');
            }
        });
    });

    // Keep list container correct size
    const listDiv = document.querySelector('.list-div');
    function calculateListHeight() {
        let listHeight = listDiv.offsetHeight;
        var totalHeight = listHeight + 80;
        
        listContainer.style.height = totalHeight + 'px';
        if (window.innerWidth >= 769) {
            listContainer.style.width = 270 + 'px';
        }
        else {
            listContainer.style.width = 'auto';
        }
    }
    listContainer.addEventListener('click', function() {
        calculateListHeight();
    });
    calculateListHeight();

    // Update duration text
    const startTimeInput = document.getElementById('start-time-input');
    const endTimeInput = document.getElementById('end-time-input');
    const durationText = document.getElementById('duration');

    function updateDurationText() {
        const startTime = new Date(startTimeInput.value);
        const endTime = new Date(endTimeInput.value);
        const differenceInMilliseconds = endTime - startTime;
        const hoursFromInput = differenceInMilliseconds / (1000 * 60 * 60);
        if (!isNaN(startTime.getTime()) && !isNaN(endTime.getTime()) && hoursFromInput>0) {
            durationText.textContent = hoursFromInput.toFixed(2); 
        } else {
            hideCommitTimeButton();
        }
    }

    // Commit time block edit
    function commitTimeBlock() {
        const startTime = new Date(startTimeInput.value);
        const endTime = new Date(endTimeInput.value);
        const differenceInMilliseconds = endTime - startTime;
        const duration = (differenceInMilliseconds / 1000).toFixed(0);
        
        activeBlock.dataset.startTime = convertUTCToLocalForInput(startTime.toISOString().slice(0,16));
        activeBlock.dataset.endTime = convertUTCToLocalForInput(endTime.toISOString().slice(0,16));
        activeBlock.dataset.duration = duration;
        activeBlock.style.border = '0px';
        activeBlock.style.backgroundColor = 'var(--primary-color)';
        resizeTimeBlocks();
        
        // construct task PUT payload
        const putPayload = {
            projectId: globalProjectId,
            taskId: globalTaskId,
            timeId: activeBlock.dataset.id,
            start: startTime,
            end: endTime,
            duration: duration
        };

        // Send PUT request to Flask API
        fetch('/time', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(putPayload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Time block updated") {
                console.log("time block updated")
                activeBlock.dataset.id = data.time_id;
                calculateTaskTotalTime(activeBlock.dataset.taskId, changed=true);
                localStorage.removeItem(`time_cache_${globalProjectId}`);
            }
        });
    }

    // Allow user to commit
    const commitTimeBlockButton = document.getElementById('commit-time-block-button');
    function showCommitTimeButton(startOrEndInput) {
        startOrEndInput.style.backgroundColor = 'yellow';
        commitTimeBlockButton.style.display = 'inline';
        updateDurationText();
    }
    function hideCommitTimeButton() {
        const startOrEndInputs = document.querySelectorAll('.datetime-input');
        startOrEndInputs.forEach(function(startOrEndInput) {
            startOrEndInput.style.backgroundColor = 'var(--primary-color)';
        });
        commitTimeBlockButton.style.display = 'none';
    }

    // Ask to save and highlight changes upon edit
    startTimeInput.addEventListener('change', function(e) {
        showCommitTimeButton(startTimeInput);
    });    
    endTimeInput.addEventListener('change', function(e) {
        showCommitTimeButton(endTimeInput);
    }); 
    

    // Commit and update stylings upon save
    commitTimeBlockButton.addEventListener('click', () => {
        commitTimeBlock();
        hideCommitTimeButton();
    });

    // Calculate task total time
    function calculateTaskTotalTime(taskId, changed) {
        const blocks = document.querySelectorAll('.time-block');
        let totalSeconds = 0;
        
        blocks.forEach(block => {
            if (block.dataset.taskId == taskId) {
                totalSeconds += parseInt(block.dataset.duration, 10);
            }
        });

        globalSeconds = totalSeconds;
        updateClock();

        const taskItem = document.querySelector(`[data-taskid="${taskId}"]`);
        taskItem.dataset.totalSeconds = globalSeconds;

        if (changed) {
            // construct PUT payload
            const putPayload = {
                taskId: taskId,
                totalSeconds: globalSeconds
            };

            // Send PUT request to Flask API
            fetch('/tasks', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(putPayload)
            })
        }
    }

    // Delete time block
    function deleteActiveTimeBlock() {
        const putPayload = {
            timeId: activeBlock.dataset.id,
            isVisible: false
        };

        // Send PUT request to Flask API
        fetch('/time', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(putPayload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Time block updated") {
                console.log("time block updated")
                taskId = activeBlock.dataset.taskId;
                
                const timeBlocks = document.querySelectorAll('.time-block');
                timeDiv.removeChild(activeBlock);
                resizeTimeBlocks();
                timeBlocks.forEach(function(b) {
                    b.style.opacity = "1";
                    b.style.borderRadius = '5px';
                });
                timeDescriptionContainer.style.height = '0px';
                timeDiv.style.borderRadius = '7px';
                activeBlock = null;
                calculateTaskTotalTime(taskId, changed=true);                
            }
            localStorage.removeItem(`time_cache_${projectId}`);
        });
    }
    const deleteActiveTimeBlockButton = document.getElementById('delete-time-block-button');
    deleteActiveTimeBlockButton.addEventListener('click',deleteActiveTimeBlock);


    // Load
    populateProjects();

</script>

</body>
</html>