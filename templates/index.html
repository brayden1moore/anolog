<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="static/icon-black.png">
    <meta charset="UTF-8">
    <title>Anolog</title>
    <style>
        :root {
            --primary-color: {{primary_color}};
        }
        .logo {
            width: 24px;
            height: 24px;
            background: conic-gradient(transparent 0% 25%, black 25% 100%);
            border-radius: 50%;
            margin-right: 8px;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, sans-serif;
            width: 65vw;
            height: 90vh;
            margin: 50px;
            margin-left: auto;
            margin-right: auto;
            background-color:var(--primary-color);
            transition: 0.3s ease;
        }
        h1 {
            display: flex;
            width: 200px;
            align-items: center;
        }
        header {
            color: rgb(0, 0, 0);
            text-align: left;
            align-items: center;
            display: flex;
        }
        #tool-div {
            position: relative;
            display: flex;
            width: 100%;
            margin-left: 25px;
            justify-content: right;
        }
        .header-icon {
            vertical-align: middle;
            width: 30px;
            height: 30px;
            margin-right: 10px;
            padding-bottom: 5px;
        }
        .signin-input {
            font: inherit;
            width: 125px;
            border: none;
            background: none;
            border-bottom: 1px solid black;
            outline: none;
            color: black;
            opacity: 0.5;
            transition: 0.3s ease;
        }
        .signin-input:hover {
            opacity: 1;
        }
        /* Webkit browsers like Chrome, Safari */
        ::-webkit-scrollbar {
            cursor: pointer;
            width: 10px;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background:  var(--primary-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background:  var(--primary-color);
        }
        .fa-solid, .fas {
            font-size: 16px;
            font-weight: 900;
        }
        .fa-regular, .far {
            font-size: 14pt;
            font-weight: 400;
        }
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #161616 var(--primary-color);
        }
        .content-div{
            margin-top: 25px;
            display: flex;
        }
        .list-container {
            flex-shrink: 0;
            box-sizing: border-box;
            background-color: #DDDDDD;
            border-radius: 10px;
            margin-bottom: 25px;
            margin-right: 25px;
            height: 700px;
            width: 270px;
            transition: 0.3s ease;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }
        .list-container:focus-within {
            overflow:visible; 
            color: #161616;           
            height: 700px;
            width: 270px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }
        .list-collapsed #project-list-ul, .list-collapsed #task-list-ul {
            transition: 0.3s ease;
            opacity: 0;
        }
        .list-collapsed:hover #project-list-ul, .list-collapsed:hover #task-list-ul, .list-container:focus-within #project-list-ul, .list-container:focus-within #task-list-ul {
            transition: 0.3s ease;
            opacity: 1;
        }
        .list-collapsed { 
            border: 0;
            padding: 0;
            color: transparent;   
            overflow: hidden;     
            height: 40px;
            width: 40px;
            box-shadow: none;
        }
        .list-collapsed:hover {   
            color: #161616; 
            overflow:visible;            
            height: 700px;
            width: 270px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }

        .list-div{
            margin-top: 20px;
            margin-left: 30px;
            margin-right: 40px;
            width: 200px;
            height: auto;
        }
        .divider {
            margin-top: 10px;
            margin-bottom: 25px;
            border-radius: 5px;
            border-top: 3px solid var(--primary-color);
            height: 1px;
            width: 100%;
        }
        .log-divider {
            margin-top: 10px;
            margin-bottom: 0px;
            border-top: 1px solid  var(--primary-color);
            height: 1px;
            width: 100%;
        }
        #menu-button {
            color:var(--primary-color);
            cursor: pointer;
            transition: 0.3s ease;
        }
        .toggle {
            border-radius: 10px 10px 0px 0px;
            background-color: #161616;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
            margin-bottom: 20px;
            height: 40px;
            transition: 0.3s ease;
            cursor: pointer;
        }
        .toggle:hover #menu-button {
            opacity: 0.5;
            justify-content: left;
        }
        a {
            color: rgb(0, 0, 0);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-bottom 0.3s ease;
        }
        a:hover {
            border-bottom: 1px solid black;
        }
        .task-or-project {
            display: inline;  
            cursor: pointer;
            color: rgb(0, 0, 0);
            border-bottom: 1px solid transparent;
            transition: border-bottom 0.3s
        }
        .task-or-project.darkmode {
            color: var(--primary-color);
        }
        .task-or-project:hover {
            border-bottom: 1px solid black;
        }
        h2 {
            margin-top: 5px;
        }
        #project-list-ul {
            margin-bottom: 30px;
            width: 95%;
            height: auto;
            max-height: 155px;
            overflow-y: scroll;
            font-size: large;
            margin-left: 0;
            padding-left: 20px;
        }
        #task-list-ul {
            width: 95%;
            overflow-y: scroll;
            margin-left: 0;
            padding-left: 20px;
            list-style-type:circle;
        }
        #new-project-li, #new-task-li {
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }
        li {
            margin-bottom: 5px;
        }
        #new-project-input, #new-task-input, .rename-input{
            font: inherit;
            width: 125px;
            border: none;
            background: none;
            border-bottom: 1px solid black;
            outline: none;
            color: black;
        }
        #new-project-input.darkmode, #new-task-input.darkmode, .rename-input.darkmode{
            color: var(--primary-color);
            border-bottom: 1px solid var(--primary-color);
        }
        #new-project-li:hover,
        #new-project-li:focus-within,
        #new-task-li:hover,
        #new-task-li:focus-within {
            opacity: 1;
        }
        #log-div {
            width: 100%;
            height: 700px;
            margin-bottom: 25px;
            transition: 0.3s ease;
        }
        .log-space {
            margin-top: 25px;
            background-color: #161616;
            border:  #161616 solid 2px;
            border-radius: 10px;
            width: 100%;
            height: 568px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
            transition: 0.3s ease;
        }
        #project-space {
            overflow-y: scroll;
            background-color: #161616;
            border:  #161616 solid 2px;
            border-radius: 10px;
            width: 100%;
            height: 100px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);
        }
        #project-content {
            margin-left: 30px;
            color:   var(--primary-color);
        }
        #log-content{
            visibility: hidden;
            height: 95%;
            color:  var(--primary-color);
            margin-left: 30px;
            margin-right: 30px;
        }
        .log-input {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-top: 30px;
            margin-bottom: 0px;
            color:  var(--primary-color);
            width: 99%;
            height: 25px;
            background: none;
            border: none;
            outline: none;
            border-bottom: var(--primary-color) solid 3px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        .log-input::placeholder {
            color: var(--primary-color);
            opacity: 0.5;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, sans-serif;
        }
        .log-input:focus,
        .log-input:hover {
            opacity: 1;
        }
        .button-common {
            display: grid;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            width: 25px;
            height: 25px;
            margin: auto;
            padding: 0px;
            margin-right: 3px;
            margin-left: 0px;
            background: none;
            color:  var(--primary-color);
            border: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .button-common:hover {
            opacity: 0.5;
        }
        .button-rotated {
            transform: rotate(0deg);
        }
        .button-spinning {
            transform: rotate(360deg);
        }
        #time {
            margin-top: 30px;
        }
        #clock-div {
            margin-top: 20px;
            display: flex;
        }

        #task-name {
            margin: 0;
            margin-right: 10px;
            margin-top: auto;
            margin-bottom: auto;
            transition: opacity 0.3s ease;
        }
        #task-checkbox {
            margin-left: 0;
            margin-right: auto;
            margin-top: 6px;
            margin-bottom: auto;
        }
        #task-name:hover{
            opacity: 0.5;
        }
        #clock {
            margin-left: 6px;
            margin-top: auto;
            margin-bottom: auto;
        }
        #log-items-container {
            margin-top: 10px;
            height: 370px;
            opacity: 1;
            overflow-y: scroll;
        }
        #pinned-logs-container {
            opacity: 1;
            box-shadow: 0 16px 13px -6px rgba(0, 0, 0, 0.5)
        }
        ::-webkit-scrollbar {
            cursor: pointer;
            width: 5px;
        }
        ::-webkit-scrollbar-thumb {
            cursor: pointer;
            background: var(--primary-color) ; 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color); 
        }
        .log-item {
            overflow: hidden;
            transition: opacity 0.3s ease;
            font-size: small;
            margin-bottom: 0px;
            cursor: pointer;
        }
        .log-item:hover {
            opacity: 1 !important;
        }
        .log-created-at {
            opacity: 0.5;
        }
        #task-checkbox {
            display: none;
        }
        #task-checkbox + label {
            display: flex;
            margin-right: auto;
            position: relative;
            padding-left: 35px;
            cursor: pointer;
            font-weight: bold;
        }

        #task-checkbox + label:before {
            margin-left: 4px;
            margin-right: auto;
            margin-top: auto;
            margin-bottom: auto;
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 13px;
            height: 13px;
            border: 2px solid var(--primary-color);
            background-color: transparent;
            border-radius: 3px;
        }
        #task-checkbox:checked + label:before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        #task-checkbox + label:after {
            content: "";
            position: absolute;
            top: 4px;
            left: 5px;
            width: 4px;
            height: 8px;
            border: solid #161616;
            border-width: 0 4px 4px 0;
            transform: rotate(45deg) scale(0);
        }
        .strikethrough {
            text-decoration: line-through;
        }
        .custom-hover-menu {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: small;
            position: absolute;
            color: #161616;
            width: 65px;
            height: 25px;
            list-style-type: none;
            border-radius: 5px;
            padding: 0;
            margin: 0;
            margin-left: 8px;
            z-index: 10;
            transition: opacity 0.3s ease;
            background-color: var(--primary-color);
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 15px 0 rgba(0, 0, 0, 0.19);

        }
        .custom-hover-menu li {
            margin-top: 3px;
            padding: 4px;
            cursor: pointer;
            transition: 0.3s ease;
        }
        .custom-hover-menu li:hover {
            opacity: 0.5;
        }
        .fade-out {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #export-div, #logout-div {
            display:inline;
            width: 350px;
            margin-left: 50px;
        }
        .export-button {
            background-color: #161616;
            height: 40px;
            width: 40px;
            margin-bottom: 0px;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.3s ease;
        }
        .export-button:hover{
            opacity:0.5;
        }
        .export-option {
            background-color: #DDDDDD;
            height: 40px;
            width: 80px;
            margin-bottom: 0px;
            outline: none;
            border: none;
            color:#161616;
            transition: 0.3s ease;
        }
        .export-option:hover {
            background-color: var(--primary-color);
        }
        .logout-button {
            background-color: #161616;
            height: 40px;
            width: 40px;
            margin-left: 5px;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.3s ease;
        }
        .logout-button:hover{
            opacity:0.5;
        }

        .color-button {
            background-color: #161616;
            height: 40px;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 5px;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.3s ease;
        }
        .color-button:hover{
            opacity:0.5;
        }

        .darkmode-button {
            background-color: #161616;
            height: 40px;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none;
            border: none;
            color: var(--primary-color);
            border-radius: 10px;
            transition: 0.3s ease;
        }

        .darkmode-button:hover{
            opacity:0.5;
        }

        #side-div {
            width: 350px;
            margin-left: 50px;
            display: none;
        }
        #pin {
            margin-right:5px;
        }
        #user-id-container{
            visibility: hidden;
        }
        .dropdown-menu {
            height: 0px;
            width: 40px;
            display: grid;
            overflow: hidden;
            position: absolute;
            top: 100%;
            right: 45px; 
            z-index: 1; 
            transition: 0.3s ease;
        }
        #export-button:hover + .dropdown-menu,
        .dropdown-menu:hover {
            height: 120px;
            width: 80px;
            transition: 0.3s ease;
        }
        #export-button:hover  {
            width: 80px;
        }
        #log-csv {
            border-radius:  0 0 10px 10px;
        }
        #picker-label {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            margin: auto;
            height: 40px;
        }
        .confetti {
            position: fixed;
            width: 5px;
            height: 10px;
            background-color: var(--primary-color);
            opacity: 0.7;
            animation: confetti-animation 1s ease-out;
            animation-duration: var(--speed, 0.3s);

            --initial-x: 0px;
            --initial-y: 0px;
            --rotation: 0deg;
        }

        .toggle-completed {
            margin-left: 2px;
            width: 15px;
            color: var(--primary-color);
            font-size: 10pt;
            cursor: pointer;
            transition: 0.3s ease;
            opacity: 0.5;  
        }
        .list-container:hover .toggle-completed {
            opacity: 0.8; 
        }
        .toggle-completed:hover {
            opacity: 1; 
        }
        .add-button {
            color: var(--primary-color);
            font-size: 12pt;
            cursor: pointer;
            transition: 0.3s ease;
            opacity: 0.5; 
        }
        .list-container:hover .add-button {
            opacity: 0.8; 
        }
        .add-button:hover {
            opacity: 1; 
        }


        @keyframes confetti-animation {
            0% {
                transform: translate(var(--initial-x), var(--initial-y)) rotate(var(--rotation));
                opacity: 1;
            }
            100% {
                transform: translate(calc(var(--initial-x) * 5), calc(var(--initial-y) * 4)) rotate(var(--rotation));
                opacity: 0;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            body {
                width: 85vw;
            }
            .list-collapsed:hover {
                overflow: hidden;
                height: 40px;
                width: 40px;
            }   
        }
    </style>
</head>

<script src="https://apis.google.com/js/platform.js" async defer></script>
<meta name="google-signin-client_id" content="791972017240-bjo86do5ri0uj11sphe0dde98j3d656t.apps.googleusercontent.com">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<body>

    <header>
        <h1 class="header"><div class="logo"></div> Anolog</h1>
        <div id="tool-div">
            <div class="darkmode-button"><i id="darkmode-icon" class="fa-regular fa-moon"></i></div>
            <input type="color" title="Recolor" id="color-picker" value={{primary_color}} style="height:40px; width:0px; opacity: 0;">
            <div class="color-button"><label for="color-picker" id="picker-label"><i class="fa-solid fa-palette"></i></label></div>

            <button title="Export" class="export-button" id="export-button"><i class="fa-solid fa-file-arrow-down"></i></button>
            <div class="dropdown-menu" id="dropdown-menu">
                <button class="export-option" id="project-csv">Projects</button>
                <button class="export-option" id="task-csv">Tasks</button>
                <button class="export-option" id="log-csv">Logs</button>
            </div>

            <button title="Logout" class="logout-button" id="logout-button"><i class="fa-solid fa-right-from-bracket"></i></button>

        </div>
    </header>
    
    <div class="content-div">
        <div id='list-container' class="list-container list-collapsed">
            <div class="toggle">
                <i id="menu-button" class="fa-solid fa-bars"></i>
            </div>
            <div class="list-div">
                <h2 class="header">Projects 
                    <i id="toggle-completed-projects" title="Show Completed Projects" class="toggle-completed fa-solid fa-eye-slash"></i>
                    <i id="add-a-project" title="Add a Project" class="add-button fa-solid fa-plus"></i>
                </h2>
                <ul id="project-list-ul">
                </ul>
                <h2 class="header">Tasks 
                    <i id="toggle-completed-tasks" title="Show Completed Tasks" class="toggle-completed fa-solid fa-eye-slash"></i>
                    <i id="add-a-task" title="Add a Task" class="add-button fa-solid fa-plus"></i></h2>
                <ul id="task-list-ul">
                </ul>
            </div>
        </div>

        <div id="log-div">
            <div id="project-space">
                <div id="project-content">
                    <h3 id="project-name"></h3>
                    <p id="hours-logged"></p>
                    <!--<textarea class="log-input" style="margin-top: 20px;" type="text" placeholder="Add a description"></textarea>-->
            </div>

            </div>
            <div class="log-space">
                <div id="log-content">
                    <div id="time">
                        <input type="checkbox" id="task-checkbox">
                        <label for="task-checkbox" id="task-name"></label>
                        
                        <h4 id="task-name"></h4>

                        <!--<button id="reset-button" class="button-common">
                            <i id="reset-icon" class="fas fa-undo"></i></i>
                        </button> -->

                        <div id="clock-div">                        
                            <button id="toggle-button" class="button-common">
                            <i id="toggle-icon" class="fa-solid fa-hourglass-end"></i>
                          </button>
                          <p id="clock">00.00.00</p>
                        </div>

                    </div>
                    <textarea class="log-input" type="text" placeholder="Add a log entry"></textarea>
                    <div id="pinned-logs-container">
                        <!--Pinned logs go here -->
                    </div>
                    <div id="log-items-container">
                        <!-- Log items go here -->
                    </div>
                </div>
            </div>
        </div>
        <div id="side-div">
            <div id="logout-div">
                <h2>Account</h2>
                <button class="logout-button" id="logout-button"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            <div id="export-div">
                <h2>Export</h2>
                <button class="export-button" id="project-csv">Projects</button>
                <button class="export-button" id="task-csv">Tasks</button>
                <button class="export-button" id="log-csv">Logs</button>
            </div>
        </div>
    </div>
    <span id="user-id-container">{{user_id}}</span>

<script>
    // Set global variables
    var globalUserId = document.getElementById('user-id-container').textContent;
    var globalProjectId;
    var globalProjectName;
    var globalTaskId;
    var globalLogId;
    var globalSeconds;
    var darkmode = {{ darkmode|lower }};
    let intervalId = null;
    let firstLoad = true;
    let showCompletedTasks = false;
    let showCompletedProjects = false;

    // Adjust log container height
    function adjustLogItemsContainerHeight() {
        const pinnedLogsContainer = document.getElementById('pinned-logs-container');
        const logItemsContainer = document.getElementById('log-items-container');

        const pinnedHeight = pinnedLogsContainer.offsetHeight;
        logItemsContainer.style.height = `${370 - pinnedHeight}px`;
    }

    // GET from /projects endpoint and populate list
    function populateProjects() {
        const ulElement = document.getElementById('project-list-ul');
        const newProjectLi = document.getElementById('new-project-li');
        const projectNameLabel = document.getElementById('project-name');
        //projectNameLabel.style.opacity = "0";

        fetch(`/projects`)
            .then(response => response.json())
            .then(data => {
                ulElement.innerHTML = "";
                // Iterate through the data and create li elements
                let first = true;
                data.forEach((project, index) => {
                    if (project.is_visible !== false){
                        if (first===true && globalProjectId===undefined){
                            globalProjectId = project.id;
                            populateTasks(globalProjectId);
                            first = false;
                        }
                        const newListItem = document.createElement('li');
                        const newLink = document.createElement('p');
                        newLink.className = 'task-or-project';

                        newLink.textContent = project.name;
                        newLink.setAttribute('data-projectId', project.id);
                        newListItem.appendChild(newLink);
                        newLink.style.opacity = '0.5';

                        if (project.id === globalProjectId){
                            newLink.style.opacity = '1';
                            newLink.style.fontWeight = 'bold';
                            projectNameLabel.textContent = project.name;
                            projectNameLabel.style.opacity = "1";
                        }
                        
                        if (project.is_completed) {
                            newLink.style.textDecoration = 'line-through';
                            newListItem.setAttribute('data-completed', true);
                            newListItem.style.height = '0px';
                            newListItem.style.overflow = 'hidden';
                            newListItem.style.margin = 'auto';
                        }
                        else {
                            newListItem.setAttribute('data-completed', false);
                        }

                        // Adjust colors for darkmode
                        if (darkmode) {
                            ulElement.style.color = "#161616";
                            newLink.style.color = "{{primary_color}}";
                        }
                        else {
                            ulElement.style.color = "black";
                            newLink.style.color = "black";
                        }

                        // Add click event listener to this list item
                        addProjectClickListener(newLink, project.id, project.name);
                        
                        // Add hover listener
                        addHoverListener(newLink, 'project', data.id);
                        
                        ulElement.appendChild(newListItem);
                    }
                });

            });
    }

    // GET from /tasks endpoint and populate list
    function populateTasks(projectId) {

        // Send projectId to /tasks endpoint
        fetch(`/tasks?project_id=${projectId}`)
        .then(response => response.json())
        .then(taskData => {
            // Get the tasks ul element
            const taskUlElement = document.getElementById('task-list-ul');

            // Clear existing tasks
            taskUlElement.innerHTML = '';

            // Iterate through the taskData and create li elements
            let first = true;
            taskData.forEach(task => {
                if (task.is_visible !== false) {
                    if (first===true){
                        if (globalTaskId!==task.id) {
                            populateLogs(task.id);
                        }
                        globalTaskId=task.id;
                        
                        first = false;

                        const logContent = document.getElementById('log-content');
                        const logDiv = document.getElementById('log-div');
                        logContent.style.visibility = 'visible';
                        logDiv.style.opacity = '1';
                    }
     
                    const newTaskListItem = document.createElement('li');
                    const newTaskLink = document.createElement('p');
                    newTaskLink.className = 'task-or-project';
                    newTaskLink.textContent = task.name;

                    // Mark completed if is_complete
                    if (task.is_completed === true) {
                        newTaskLink.style.textDecoration = 'line-through';
                        newTaskListItem.setAttribute('data-completed', true);
                        newTaskListItem.style.height = '0px';
                        newTaskListItem.style.overflow = 'hidden';
                        newTaskListItem.style.margin = 'auto';
                    }
                    else {
                        newTaskLink.style.textDecoration = '';
                        newTaskListItem.setAttribute('data-completed', false);
                    }

                    // Make bold if it is the selected task
                    if (task.id === globalTaskId) {
                        newTaskLink.style.opacity = '1';
                        newTaskLink.style.fontWeight = 'bold';

                    }
                    else {
                        newTaskLink.style.opacity = '0.5';
                        newTaskLink.style.fontWeight = 'normal';
                    }

                    // Adjust colors for darkmode
                    if (darkmode) {
                        taskUlElement.style.color = "#161616";
                        newTaskLink.style.color = "{{primary_color}}";
                        }
                    else {
                        taskUlElement.style.color = "black";
                        newTaskLink.style.color = "black";
                    }

                    newTaskLink.setAttribute('data-taskId', task.id);
                    newTaskListItem.appendChild(newTaskLink);
                    taskUlElement.appendChild(newTaskListItem);

                    // Add click listener
                    addTaskClickListener(newTaskLink, task.id, task.name);

                    // Add hover listener
                    addHoverListener(newTaskLink, 'task', task.id);
                }
            });

        });
    }

    // GET from /tasks /hours and /logs endpoints and populate content
    function populateLogs(taskId, animation) {
        const logItemsContainer = document.getElementById('log-items-container');
        logItemsContainer.innerHTML = '';

        const pinnedLogsContainer = document.getElementById('pinned-logs-container');
        pinnedLogsContainer.innerHTML = '';
        
        const taskName = document.getElementById('task-name');
        const taskCheckbox = document.getElementById('task-checkbox');
        taskName.style.opacity = '0';
        
        getHours(globalProjectId);

        fetch(`/tasks?task_id=${taskId}`)
            .then(response => response.json())
            .then(data => {

                // Mark completed if is_complete
                if (data[0].is_completed === true) {
                    taskName.style.textDecoration = 'line-through';
                    taskCheckbox.checked = true;
                }
                else {
                    taskName.style.textDecoration = '';
                    taskCheckbox.checked = false;
                }
                
                taskName.textContent = data[0].name;
                globalSeconds = data[0].total_seconds;
                updateClock();
                taskName.style.opacity = '1';

            });

        let logIds = [];
        let logPinnedStatuses = [];
        fetch(`/logs?task_id=${taskId}`)
            .then(response => response.json())
            .then(data => {
                // Append responses to entry log
                data.forEach((log, index) => {
                    showIt = (log.description.includes("Timer stop (") || log.description.includes("Timer start (")) ? false : true;
                    console.log(showIt);
                    if (showIt) {
                        const dateObj = new Date(log.created_at);
                        const localDateStr = dateObj.toLocaleString();

                        let pin = '';
                        let opacity = '0.5';
                        if (log.is_pinned) {
                            opacity = '0.9';
                            pin = '<i class="fa-solid fa-thumbtack" id="pin" style="font-size: 8pt"></i>';
                        }

                        const escapedLogText = log.description.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const logEntry = `
                            <div class="log-item" data-logId="${log.id}" data-isPinned=${log.is_pinned} style="opacity:${opacity};">
                                <br id="first-break">${pin}
                                <span class="log-created-at">${localDateStr}</span><br>
                                <span class="log-description" style="white-space: pre-line;">${escapedLogText}</span>
                                <div class="log-divider"></div>
                            </div>`;
                        
                        if (log.is_pinned) {
                            pinnedLogsContainer.insertAdjacentHTML('beforeend', logEntry);
                            logItemsContainer.insertAdjacentHTML('beforeend', logEntry);
                        }
                        else{
                            logItemsContainer.insertAdjacentHTML('beforeend', logEntry);
                        }
                        logIds.push(log.id);
                        logPinnedStatuses.push(log.is_pinned);
                    }
                });

                // Add click listeners after
                const logItems = document.querySelectorAll('.log-item');
                logItems.forEach((logItem, index) => {
                    addLogClickListener(logItem, logIds[index]);
                });
                const unpinnedItems = logItemsContainer.querySelectorAll('.log-item');
                unpinnedItems.forEach((unpinnedItem,index) => {
                    if (unpinnedItem.getAttribute('data-isPinned') === 'true') {
                        pin = unpinnedItem.querySelector('#pin')
                        unpinnedItem.removeChild(pin);
                        unpinnedItem.style.height = '0px';
                        unpinnedItem.style.opacity = '0.5';
                        unpinnedItem.setAttribute('data-isPinned', 'false');
                    }
                });
                adjustLogItemsContainerHeight();   
 
            })
            
    }

    // GET to /hours endpoint
    function getHours(projectId) {
        const hoursLogged = document.getElementById('hours-logged');

        // Send GET request to Flask API
        fetch(`/hours?project_id=${projectId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
            .then(data => {
                hoursLogged.textContent = '';
                hoursLogged.textContent = data.total_hours + ' hours logged';
            });

    }

    // POST to /projects endpoint and append list
    function addProject() {
        const projectUlElement = document.getElementById('project-list-ul');
        const newProjectLi = document.getElementById('new-project-li');
        const newProjectInput = document.getElementById('new-project-input');
        const newProjectName = newProjectInput.value;

        if (newProjectName) {
            // Construct payload
            const payload = {
                name: newProjectName,
                user_id: globalUserId
            };

            // Send POST request to Flask API
            fetch('/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json())
            .then(data => {
                if (data.message === "Project created") {
                    // Create and insert the new list item before the input item
                    const newListItem = document.createElement('li');
                    const newLink = document.createElement('p');
                    newLink.className = 'task-or-project';
                    newLink.textContent = newProjectName;
                    newListItem.setAttribute('data-completed', false);

                    // Adjust colors for darkmode
                    if (darkmode) {
                        newLink.classList.add('darkmode');
                    }

                    newListItem.appendChild(newLink);
                    projectUlElement.insertBefore(newListItem, newProjectLi);
                    newProjectInput.value = '';
                    // Add click event listener to this list item
                    addProjectClickListener(newLink, data.id, newProjectName);

                    // Add hover listener
                    addHoverListener(newLink, 'project', data.id);

                }
            });
        }
    }

    // POST to /tasks endpoint and append list
    function addTask(projectId) {
        const newTaskLi = document.getElementById('new-task-li');
        const newTaskInput = document.getElementById('new-task-input');
        const newTaskName = newTaskInput.value;
        const taskUlElement = document.getElementById('task-list-ul');
        const logDiv = document.getElementById('log-div');

        if (newTaskName) {
            // Construct payload
            const payload = {
                projectId: projectId,
                taskName: newTaskName
            };

            // Send POST request to Flask API
            fetch('/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json())
            .then(data => {
                if (data.message === "Task created") {
                    // Create and insert the new list item before the input item
                    const newListItem = document.createElement('li');
                    const newLink = document.createElement('p');
                    newLink.className = 'task-or-project';
                    newLink.textContent = newTaskName;
                    newListItem.setAttribute('data-completed', false);

                    newListItem.appendChild(newLink);
                    taskUlElement.insertBefore(newListItem, newTaskLi);
                    newTaskInput.value = '';
                    newLink.setAttribute('data-taskId', data.id);

                    // Adjust colors for darkmode
                    if (darkmode) {
                        newLink.classList.add('darkmode');
                    }

                    // Add click listener
                    addTaskClickListener(newLink, data.id, data.name);

                    // Add hover listener
                    addHoverListener(newLink, 'task', data.id);
                }
            });
        }
    }

    // POST to /logs endpoint and append list. PUT to /tasks
    function addLog(taskId, logType) {
        const initialTaskId = taskId;  // Store the taskId at the time of logging
        let isTimer = true;
        const logInput = document.querySelector('.log-input');
        const clock = document.getElementById('clock');
        let logText;
        
        if (logType === "Start") {
            logText = `Timer start (${clock.textContent})`;
        }
        else if (logType === "Stop") {
            logText = `Timer stop (${clock.textContent})`;
        }
        else {
            logText = logInput.value;
            isTimer = false;

            // Build log entry
            const tempId = Math.floor(Math.random() * 90000) + 10000;
            const dateObj = new Date();
            const formattedDate = dateObj.toLocaleString('en-US');
            const escapedLogText = logText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const logEntry = `
                                <div class="log-item" data-logId="tmp${tempId}" data-isPinned=false style="opacity:0.5;">
                                    <br id="first-break">
                                    <span class="log-created-at">${formattedDate}</span><br>
                                    <span class="log-description" style="white-space: pre-line;">${escapedLogText}</span>
                                    <div class="log-divider"></div>
                                </div>`;
            const logItemsContainer = document.getElementById('log-items-container');
            logItemsContainer.insertAdjacentHTML('afterBegin', logEntry);
            const logItem = logItemsContainer.querySelector(`[data-logId="tmp${tempId}"]`);
            addLogClickListener(logItem);
        }

        // construct PUT payload
        const putPayload = {
            taskId: taskId,
            totalSeconds: globalSeconds
        };

        // Send PUT request to Flask API
        fetch('/tasks', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(putPayload)
        }).then(response => response.json())
        .then(data => {
            if (data.message === "Task updated") {
                console.log("Task updated")
            }
        });

        if (taskId) {
            // Construct POST payload
            const postPayload = {
                taskId: taskId,
                description: logText,
                createdAt: new Date()
            };

            // Send POST request to Flask API
            fetch('/logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postPayload)
            }).then(response => response.json())
            .then(data => {
                if (data.message === "Log created") {
                    if (globalTaskId === initialTaskId && isTimer === false) {
                        // Add log to list
                        //populateLogs(taskId, animation=false);
                    }
                }
            });

        }
    }

    // Add a click listener to a project link
    function addProjectClickListener(newLink, projectId, projectName) {
        newLink.addEventListener('click', function() {

            // Stop clock if running
            const toggleIcon = document.getElementById('toggle-icon');
            if (toggleIcon.classList.contains('fa-hourglass-half')) {
                toggleClock();
            }

            // Show tasks
            if (projectId !== globalProjectId){
                globalTaskId = undefined;
                populateTasks(projectId);
            }
            
            // Fade log if picking a new project
            const logContent = document.getElementById('log-content');
            const logDiv = document.getElementById('log-div');
            if (globalProjectId !== projectId) {
                logContent.style.visibility = 'hidden';
                logDiv.style.opacity = "0.5";
            }

            // Update global
            globalProjectId = projectId;

            // Update project name label
            console.log(projectName);
            const projectNameLabel = document.getElementById('project-name');
            projectNameLabel.textContent = projectName;
            
            const allLinks = document.querySelectorAll('#project-list-ul li p');
            allLinks.forEach(link => {
                link.style.opacity = '0.5';
                link.style.fontWeight = 'normal';
            });
            newLink.style.fontWeight = 'bold';
            newLink.style.opacity = '1';

        });
    }

    // Add click event listener to task link
    function addTaskClickListener(newLink, taskId) {
        newLink.addEventListener('click', function() {

            console.log("task clicked", taskId);
            console.log("current global", globalTaskId);

            // Stop clock if running
            const toggleIcon = document.getElementById('toggle-icon');
            if (toggleIcon.classList.contains('fa-hourglass-half') && taskId !== globalTaskId) {
                toggleClock();
                updateClock();
            }

            if (taskId!==globalTaskId) {
                // Show logs
                populateLogs(taskId);
                
                // Update global
                globalTaskId = taskId;
            }

            // Update bold
            const allLinks = document.querySelectorAll('#task-list-ul li p');
            allLinks.forEach(link => {
                link.style.opacity = '0.5';
                link.style.fontWeight = 'normal';
            });
            newLink.style.fontWeight = 'bold';
            newLink.style.opacity = '1';

        });
    }

    // Add click listener to log 
    function addLogClickListener(logItem) {
        logItem.addEventListener('dblclick', function(e) {
            pinLog(logItem);
        })
    }

    // Add unload listener
    window.addEventListener('beforeunload', function() {
        const toggleIcon = document.getElementById('toggle-icon');
        if (toggleIcon.classList.contains('fa-hourglass-half')) {
            toggleClock();
        }
    });

    // Add hover event listener to project link
    function addHoverListener(newLink, elementType, elementId) {
        let hoverMenu;
        let timeoutId;

        newLink.addEventListener('click', function(e) {
            // Remove existing hover menus
            const existingMenu = document.querySelector('.custom-hover-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // Create custom hover menu
            hoverMenu = document.createElement('ul');
            hoverMenu.className = 'custom-hover-menu';

            // Rename option with FontAwesome icon
            const renameOption = document.createElement('li');
            const renameIcon = document.createElement('i');
            renameIcon.className = 'fa fa-pencil-alt';  // FontAwesome class for pencil/edit icon
            renameOption.appendChild(renameIcon);

            renameOption.addEventListener('click', function() {
                // Hide hover menu
                hoverMenu.remove();

                // Create an input element
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.className = 'rename-input';
                inputElement.value = newLink.textContent;

                // Replace the link with the input element
                newLink.parentNode.replaceChild(inputElement, newLink);

                // Focus the input and select its content
                inputElement.focus();
                inputElement.select();

                // Revert changes if the user clicks away
                const blurHandler = function() {
                    if (inputElement.parentNode) {
                        inputElement.parentNode.replaceChild(newLink, inputElement);
                    }
                };
                inputElement.addEventListener('blur', blurHandler);

                // Listen for Enter key press
                inputElement.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        inputElement.removeEventListener('blur', blurHandler);
                        
                        if (elementType==='project') {
                            // Run renameProject function
                            renameProject(globalProjectId, inputElement.value);
                        }
                        else {
                            // Run renameTask function
                            renameTask(globalTaskId, inputElement.value);
                        }

                        // Replace the input back with the link
                        if (inputElement.parentNode) {
                            inputElement.parentNode.replaceChild(newLink, inputElement);
                        }

                        // Update the link text
                        newLink.textContent = inputElement.value;
                        
                    }
                });
            });

            // Complete option with FontAwesome icon
            const completeOption = document.createElement('li');
            const completeIcon = document.createElement('i');
            let isCompleted = true;

            if (newLink.style.textDecoration === 'line-through') {
                completeIcon.className = 'fa fa-undo';
                isCompleted = false;
            }
            else {
                completeIcon.className = 'fa fa-check';
            }
            
            completeOption.appendChild(completeIcon);
            completeOption.addEventListener('click', function() {

                if (completeIcon.className === 'fa fa-check') {
                    // Confetti
                    const x = event.clientX;
                    const y = event.clientY;
                    createConfetti(x, y);
                }

                if (elementType==='project'){
                    completeProject(globalProjectId, isCompleted);
                }
                else {
                    const taskCheckbox = document.getElementById('task-checkbox');
                    const taskLabel = document.getElementById('task-name');
                    completeTask(taskCheckbox, taskLabel, isCompleted);
                }
                
                // Remove the hover menu
                if (hoverMenu && hoverMenu.parentNode) {
                    hoverMenu.parentNode.removeChild(hoverMenu);
                }
            })
            
            // Delete option with FontAwesome icon
            let deleteConfirmed = false;  
            const deleteOption = document.createElement('li');
            const deleteIcon = document.createElement('i');
            deleteIcon.className = 'fa fa-trash';  // FontAwesome class for trash/delete icon
            deleteOption.appendChild(deleteIcon);

            deleteOption.addEventListener('click', function() {
                if (!deleteConfirmed) {
                    // First click: Ask for confirmation
                    deleteIcon.className = 'fa fa-question';  // Change to a 'confirm' icon
                    deleteConfirmed = true;
                } else {
                    // Second click: Proceed with deletion
                    if (elementType==='project') {
                        deleteProject(globalProjectId);
                        const taskList = document.getElementById('task-list-ul');
                        taskList.innerHTML = "";
                    }
                    else {
                        deleteTask(globalTaskId);
                    }

                    // Remove the hover menu
                    if (hoverMenu && hoverMenu.parentNode) {
                        hoverMenu.parentNode.removeChild(hoverMenu);
                    }

                    deleteConfirmed = false;  // Reset flag
                }
            });

            // Append options to hover menu
            hoverMenu.appendChild(completeOption);
            hoverMenu.appendChild(renameOption);
            hoverMenu.appendChild(deleteOption);

            // Append hover menu to document
            document.body.appendChild(hoverMenu);

            // Position the hover menu to the right of the list item
            const rect = newLink.getBoundingClientRect();
            hoverMenu.style.top = (rect.top + window.scrollY) + 'px';
            hoverMenu.style.left = (rect.right + window.scrollX) + 'px';


            // Clear any existing timeout
            if (timeoutId) {
                clearTimeout(timeoutId);
            }

            hoverMenu.addEventListener('mouseleave', function() {
                // Set a timeout to fade out the menu after 1 second
                timeoutId = setTimeout(() => {
                    hoverMenu.classList.add('fade-out');
                    setTimeout(() => {
                        hoverMenu.remove();
                    }, 300);  // Remove after the transition completes
                }, 300);
            });

            hoverMenu.addEventListener('mouseenter', function() {
                // Clear the timeout and fade-out class if the mouse re-enters the menu
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                hoverMenu.classList.remove('fade-out');
            });

        });

        newLink.addEventListener('mouseleave', function(e) {
            // If the menu exists and isn't hovered, set a timeout to remove it
            if (hoverMenu && !hoverMenu.matches(':hover')) {
                hoverMenu.classList.add('fade-out');
                timeoutId = setTimeout(() => {
                    hoverMenu.remove();
                }, 300);
            }
        });
    }

    // Update clock
    let currentRotation = 0;
    let startTime = null;
    function updateClock(countUp) {
        const button = document.querySelector('.button-common');
        if (countUp === true) {
            currentRotation = 180;
        }

        if (countUp === true && startTime === null) {
            startTime = new Date().getTime() - (globalSeconds * 1000);
        }

        if (startTime !== null) {
            const currentTime = new Date().getTime();
            globalSeconds = Math.floor((currentTime - startTime) / 1000);
        }
    
        const hrs = String(Math.floor(globalSeconds / 3600)).padStart(2, '0');
        const mins = String(Math.floor((globalSeconds % 3600) / 60)).padStart(2, '0');
        const secs = String(globalSeconds % 60).padStart(2, '0');
        clock.textContent = `${hrs}.${mins}.${secs}`;
    }

    // Play pause toggle
    let toggleClock = (function() {
        // Rotate hourglass
        const button = document.querySelector('.button-common');

        // Start or stop timer
        let intervalId = null;
        return function() {
            const toggleIcon = document.getElementById('toggle-icon');
            
            if (toggleIcon.classList.contains('fa-hourglass-end')) {
                    updateClock(true);
                    button.style.transform = `rotate(180deg)`;
                    addLog(globalTaskId, logType="Start");
                    toggleIcon.classList.remove('fa-hourglass-end');
                    toggleIcon.classList.add('fa-hourglass-half');
                    intervalId = setInterval(() => updateClock(true), 1000);
                } else {
                    startTime = null;
                    addLog(globalTaskId, logType="Stop");
                    toggleIcon.classList.remove('fa-hourglass-half');
                    toggleIcon.classList.add('fa-hourglass-end');
                    clearInterval(intervalId);
                    button.style.transform = `rotate(${currentRotation-180}deg)`;
                    currentRotation = 0;
                }
            };
    })();

    document.addEventListener("DOMContentLoaded", function() {
        // Toggle on click
        const toggleButton = document.getElementById('toggle-button');
        toggleButton.addEventListener('click', function() {
            toggleClock();
        })

        // Add log upon enter
        const logInput = document.querySelector('.log-input');
        logInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Add a new line
                    logInput.value += '\n';
                } else {
                    addLog(globalTaskId, logType='Comment');
                    logInput.value = '';
                }
                e.preventDefault(); // Prevent default action
            }
        });

        // Mark task as completed or not yet completed when taskbox is checked
        const taskCheckbox = document.getElementById('task-checkbox');
        const taskLabel = document.getElementById('task-name');

        taskCheckbox.addEventListener('click', function(event) {
            const isCompleted = taskCheckbox.checked ? true : false;
            completeTask(taskCheckbox, taskLabel, isCompleted);

            if (isCompleted === true) {
                // Confetti
                const x = event.clientX;
                const y = event.clientY;
                createConfetti(x, y);
            }

            const toggleIcon = document.getElementById('toggle-icon');
            if (toggleIcon.classList.contains('fa-hourglass-half')){
                toggleClock();
            }
        });
    });

    // Complete task
    function completeTask(taskCheckbox, taskLabel, isCompleted) {
        const selectedTask = document.querySelector(`p[data-taskId="${globalTaskId}"]`);
        const listItem = selectedTask.closest('li');

        if (isCompleted) {
            selectedTask.style.textDecoration = 'line-through';
            taskLabel.style.textDecoration = 'line-through';
            taskCheckbox.checked = true;
            listItem.setAttribute('data-completed',true);
        }
        else {
            selectedTask.style.textDecoration = '';
            taskLabel.style.textDecoration = '';
            taskCheckbox.checked = false;
            listItem.setAttribute('data-completed',false);
        }

        fetch(`/tasks`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: globalTaskId,
                isCompleted: isCompleted,
                totalSeconds: globalSeconds
            })
            })
            .then(response => response.json())
            .then(data => {
                console.log(isCompleted);
                console.log(data); // Handle the response
                //populateTasks(globalProjectId);
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Complete project
    function completeProject(projectId, isCompleted) {
        const selectedProject = document.querySelector(`p[data-projectId="${globalProjectId}"]`);
        const listItem = selectedProject.closest('li');
        
        if (isCompleted) {
            selectedProject.style.textDecoration = 'line-through';
            listItem.setAttribute('data-completed',true);
        }
        else {
            selectedProject.style.textDecoration = '';
            listItem.setAttribute('data-completed',false);
        }

        fetch(`/projects`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                isCompleted: isCompleted
            })
            })
            .then(response => response.json())
            .then(data => {
                //populateProjects();
            })
            .catch(error => {
            console.error(error); // Handle errors
        }); 
    }

    // Rename project
    function renameProject(projectId, newName){
        fetch(`/projects`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                name: newName
            })
            })
            .then(response => response.json())
            .then(data => {
            populateProjects();
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Delete project
    function deleteProject(projectId){
        fetch(`/projects`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                projectId: projectId,
                isVisible: false
            })
            })
            .then(response => response.json())
            .then(data => {
            populateProjects();
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Rename task
    function renameTask(taskId, newName){

        fetch(`/tasks`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                name: newName,
                totalSeconds: globalSeconds
            })
            })
            .then(response => response.json())
            .then(data => {
                const taskLabel = document.getElementById('task-name');
                taskLabel.textContent = newName;
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Delete task
    function deleteTask(taskId){
        fetch(`/tasks`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                isVisible: false,
                totalSeconds: globalSeconds
            })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Task updated") {
                    const logDiv = document.getElementById('log-div');
                    const logContent = document.getElementById('log-content');
                    globalTaskId=undefined;
                    populateTasks(globalProjectId);
                }
            })
            .catch(error => {
            console.error(error); // Handle errors
        });
    }

    // Pin log
    function pinLog(logItem) {

        const logItemsContainer = document.getElementById('log-items-container');
        const pinnedLogsContainer = document.getElementById('pinned-logs-container');

        const logId = logItem.getAttribute('data-logId');
        const isPinned = logItem.getAttribute('data-isPinned');

        if (logItem) {
            if (isPinned === 'true') {
                // Unpin if pinned
                hiddenLogItem = logItemsContainer.querySelector(`[data-logId="${logId}"]`);
                hiddenLogItem.style.height = 'auto';
                hiddenLogItem.setAttribute('data-isPinned', 'false');
                pinnedLogsContainer.removeChild(logItem);
                logItem.setAttribute('data-isPinned', 'false');
            } else {
                // Pin if not pinned
                let clonedLogItem = logItem.cloneNode(true);  
                firstBreak = clonedLogItem.querySelector('#first-break');
                clonedLogItem.removeChild(firstBreak);
                logItem.style.height = '0px';
                logItem.style.overflow = 'hidden';
                pin = '<br><i class="fa-solid fa-thumbtack" style="font-size: 8pt"></i>';
                clonedLogItem.insertAdjacentHTML('afterBegin',pin);
                clonedLogItem.style.opacity = '0.9';
                pinnedLogsContainer.appendChild(clonedLogItem);
                clonedLogItem.setAttribute('data-isPinned', 'true');
                addLogClickListener(clonedLogItem);
            }
        
        adjustLogItemsContainerHeight();
        }

        // construct task PUT payload
        const putPayload = {
            taskId: globalTaskId,
            totalSeconds: globalSeconds
        };

        // Send PUT request to Flask API
        fetch('/tasks', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(putPayload)
        }).then(response => response.json())
        .then(data => {
            if (data.message === "Task updated") {
                console.log("Task updated");
                // Update logs
                fetch(`logs`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    logId: logId,
                    isPinned: isPinned !== 'true'
                })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Log updated") {
                    }
                })
            }
        });
    }

    // Add click listeners to export buttons
    const projectExport = document.getElementById('project-csv');
    projectExport.addEventListener('click', function() {
        exportCsv('user_id',globalUserId);
    })
    const taskExport = document.getElementById('task-csv');
    taskExport.addEventListener('click', function() {
        exportCsv('project_id',globalProjectId);
    })
    const logExport = document.getElementById('log-csv');
    logExport.addEventListener('click', function() {
        exportCsv('task_id',globalTaskId);
    })

    // Ping export backend
    function exportCsv(arg, id) {
        // Generate filename based on arg
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');

        let prefix = 'anolog_';

        let dataType = '';
        if (arg === 'user_id') {
            dataType = 'projects';
        } else if (arg === 'project_id') {
            dataType = 'tasks';
        } else if (arg === 'task_id') {
            dataType = 'logs';
        }

        const filename = `${prefix}${dataType}_${year}${month}${day}${hour}${minute}`;

        // Fetch CSV data and trigger download
        fetch(`/export_csv?${arg}=${id}`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${filename}.csv`;  // Use the dynamically generated filename
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error:', error));
    }

    // Collapse left menu
    document.querySelector('.toggle').addEventListener('click', function() {
        const listContainer = document.querySelector('.list-container')
        const menuButton = document.getElementById('menu-button');
        if (menuButton.className === "fa-solid fa-bars") {
            listContainer.classList.remove('list-collapsed');
            menuButton.className = "fa-solid fa-square-minus";
        }
        else {          
            listContainer.classList.add('list-collapsed');
            void listContainer.offsetWidth;
            menuButton.className = "fa-solid fa-bars";
        }
    });

    // Open export menu
    const exportButton = document.getElementById('export-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    function addBorderRadius() {
        exportButton.style.borderRadius = '10px 10px 0 0';
        exportButton.style.width = '80px';
    }
    function removeBorderRadius() {
        exportButton.style.borderRadius = '10px';  
        exportButton.style.width = '40px';
    }
    exportButton.addEventListener('mouseover', addBorderRadius);
    exportButton.addEventListener('mouseout', removeBorderRadius);
    dropdownMenu.addEventListener('mouseover', addBorderRadius);
    dropdownMenu.addEventListener('mouseout', removeBorderRadius);

    // Collapse menu only on mobile
    const listContainer = document.querySelector('.list-container');
    const menuButton = document.getElementById('menu-button');
    function setClassForScreenSize() {
        if (window.innerWidth >= 769) {
            listContainer.classList.remove('list-collapsed');
            menuButton.className = "fa-solid fa-square-minus";
        } else {
            listContainer.classList.add('list-collapsed');
            menuButton.className = "fa-solid fa-bars";
        }
    }
    setClassForScreenSize();
    window.addEventListener('resize', setClassForScreenSize);

    // Pick color
    document.getElementById('picker-label').addEventListener('click', function() {
        document.getElementById('color-picker').click();
    });
    document.addEventListener('input', function(event) {
        if (event.target.id === 'color-picker') {
            document.documentElement.style.setProperty('--primary-color', event.target.value);
        }
    });

    // Update user's color field
    document.addEventListener('change', function(event) {
        if (event.target.id === 'color-picker') {
            document.documentElement.style.setProperty('--primary-color', event.target.value);
            updateFavicon(event.target.value);
            // Send PUT to /user endpoint
            fetch('/user', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({userId: globalUserId, color: event.target.value }),
            });
        }
    });

    // Confetti
    function createConfetti(x, y) {
        const confettiCount = 40;
        const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];

            for(let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.backgroundColor = randomColor;
                confetti.className = 'confetti';
                confetti.style.left = `${x}px`;
                confetti.style.top = `${y}px`;
                document.body.appendChild(confetti);

                // Randomize initial position and rotation
                confetti.style.setProperty('--initial-x', `${Math.random() * 30 - 15}px`);
                confetti.style.setProperty('--initial-y', `${Math.random() * 30 - 15}px`);
                confetti.style.setProperty('--rotation', `${Math.random() * 360}deg`);
                confetti.style.setProperty('--speed', `${Math.random() * .1 + 0.5}s`);

                // Remove after animation completes
                confetti.addEventListener('animationend', function() {
                confetti.remove();
                });
            }
    }

    // Logout 
    document.getElementById('logout-button').addEventListener('click', function() {
                        window.location.href = '/logout';
                    });

    // Toggle darkmode
    function toggleDarkmode(initialToggle) {
        console.log('Darkmode', darkmode);
        const list = document.querySelector('.list-container');
        const listItems = document.querySelectorAll('.task-or-project');
        const logo = document.querySelector('.logo');
        const headers = document.querySelectorAll('h2');
        const title = document.querySelector('h1');
        const darkmodeIcon = document.querySelector('#darkmode-icon');
        const projectList = document.getElementById('project-list-ul');
        const taskList = document.getElementById('task-list-ul');

        if (initialToggle) {
            darkmode = !darkmode;
        }
        else {
            // Toggle new task inputs if they exist
            const newProjectInput = document.getElementById('new-project-input');
            const newTaskInput = document.getElementById('new-task-input');
            
            if (darkmode) {
                newProjectInput.classList.remove('darkmode');
                newTaskInput.classList.remove('darkmode');
            }
            else {
                newProjectInput.classList.add('darkmode');
                newTaskInput.classList.add('darkmode');
            }
        }

        if (darkmode) {
            // Make lightmode
            darkmode = false;
            document.body.style.backgroundColor = "var(--primary-color)";
            
            for (let header of headers) {
                header.style.color = "black";
            }
            for (let item of listItems) {
                item.style.color =  "black";
            }

            projectList.style.color = "black";
            taskList.style.color = "black";
            darkmodeIcon.className = "fa-regular fa-moon";
            darkmodeIcon.style.fontSize = "14pt";
            list.style.backgroundColor = '#DDDDDD';
            title.style.color = "black";
            logo.style.background = "conic-gradient(transparent 0% 25%, black 25% 100%)";
        }
        else {
            // Make darkmode
            darkmode = true;
            document.body.style.backgroundColor = "#252525";
            
            for (let header of headers) {
                header.style.color = "var(--primary-color)";
            }
            for (let item of listItems) {
                item.style.color =  "var(--primary-color)";
            }

            projectList.style.color = "#161616";
            taskList.style.color = "#161616";
            darkmodeIcon.className = "fa-solid fa-moon";
            darkmodeIcon.style.fontSize = "14pt";
            list.style.backgroundColor = "transparent";
            title.style.color =  "var(--primary-color)";
            logo.style.background = "conic-gradient(transparent 0% 25%, var(--primary-color) 25% 100%)";
        }

        // Send PUT to /user endpoint
        fetch('/user', {
            method: 'PUT',
            headers: {
                    'Content-Type': 'application/json',
            },
            body: JSON.stringify({userId: globalUserId, darkmode: darkmode }),
        });
    }
    const darkmodeButton = document.querySelector('.darkmode-button');
    darkmodeButton.addEventListener('click', function() {
        toggleDarkmode();
    })
    toggleDarkmode(initialToggle=true);

    // Dynamically change icon
    function updateFavicon(color) {
        let canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        let ctx = canvas.getContext('2d');
        
        // Draw the 3/4 filled circle
        ctx.beginPath();
        ctx.arc(16, 16, 16, -0.5 * Math.PI, -2 * Math.PI, true);
        ctx.lineTo(16, 16);
        ctx.fillStyle = color;
        ctx.fill();

        // Update favicon
        let link = document.querySelector("link[rel~='icon']");
        if (!link) {
            link = document.createElement('link');
            link.rel = 'icon';
            document.getElementsByTagName('head')[0].appendChild(link);
        }
        link.href = canvas.toDataURL('image/x-icon');
    }
    updateFavicon('{{ primary_color }}');

    // Toggle show completed
    function toggleShowCompleted(type) {
        let completed = document.querySelectorAll(`#${type}-list-ul li[data-completed=true]`);
        if (type === 'task') {
            showCompleted = showCompletedTasks;
        }
        else {
            showCompleted = showCompletedProjects;
        }
        completed.forEach(item => {
            if (showCompleted) {
                item.style.height = '0px';
                item.style.overflow = 'hidden';
                item.style.margin = 'auto';
            } else {
                item.style.height = 'auto';
                item.style.overflow = 'visible';
                item.style.marginBottom = '5px';
            }
        });
        if (type === 'task') {
            showCompletedTasks = !showCompletedTasks;
        }
        else {
            showCompletedProjects = !showCompletedProjects;
        }

    }
    const showCompletedTaskToggle = document.getElementById('toggle-completed-tasks');
    showCompletedTaskToggle.addEventListener('click', function() {
        toggleShowCompleted('task');
        if (showCompletedTasks) {
            showCompletedTaskToggle.className = 'toggle-completed fa-solid fa-eye';
            showCompletedTaskToggle.title = "Hide Completed Tasks";
        } else {
            showCompletedTaskToggle.className = 'toggle-completed fa-solid fa-eye-slash';
            showCompletedTaskToggle.title = "Hide Completed Tasks";
        }
    });
    const showCompletedProjectToggle = document.getElementById('toggle-completed-projects');
    showCompletedProjectToggle.addEventListener('click', function() {
        toggleShowCompleted('project');
        if (showCompletedProjects) {
            showCompletedProjectToggle.className = 'toggle-completed fa-solid fa-eye';
            showCompletedProjectToggle.title = "Hide Completed Projects";
        } else {
            showCompletedProjectToggle.className = 'toggle-completed fa-solid fa-eye-slash';
            showCompletedProjectToggle.title = "Hide Completed Projects";
        }
    });

    // Add a task or project
    function addNewItem(type) {
        const projectUlElement = document.getElementById('project-list-ul');
        const taskUlElement = document.getElementById('task-list-ul');
        const targetUl = type === 'project' ? projectUlElement : taskUlElement;

        const newLi = document.createElement('li');
        newLi.id = `new-${type}-li`;

        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.id = `new-${type}-input`;
        if (darkmode) {
            newInput.classList.add('darkmode');
        }

        newInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (type === 'project') {
                    addProject();
                } else if (type === 'task') {
                    addTask(globalProjectId);
                }
                newInput.focus();
            }
        });

        // Remove the input when it loses focus
        newInput.addEventListener('blur', function() {
            targetUl.removeChild(newLi);
        });

        newLi.appendChild(newInput);
        targetUl.insertBefore(newLi, targetUl.firstChild);
        newInput.focus();
    }

    document.querySelectorAll('.add-button').forEach(button => {
        button.addEventListener('click', function() {
            if (this.id === 'add-a-task') {
                addNewItem('task');
            } else if (this.id === 'add-a-project') {
                addNewItem('project');
            }
        });
    });

    // Keep project and task list heights OK
    function adjustTaskListHeight() {
        const projectList = document.getElementById('project-list-ul');
        const taskList = document.getElementById('task-list-ul');
        const listContainer = document.getElementById('list-container');

        const additionalHeight = 335 + (155 - projectList.offsetHeight);
        taskList.style.height = `${additionalHeight}px`;
    }
    document.querySelectorAll('.list-container').forEach(div => {
        div.addEventListener('click', adjustTaskListHeight);
    });


    // Load
    populateProjects();

</script>

</body>
</html>